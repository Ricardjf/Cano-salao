<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Completo - Caño Salao</title>

    <link rel="stylesheet" href="../index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos específicos para admin - COMPLETOS */
        :root {
            --admin-primary: #2c3e50;
            --admin-secondary: #34495e;
            --admin-accent: #3498db;
            --admin-success: #27ae60;
            --admin-danger: #e74c3c;
            --admin-warning: #f39c12;
            --admin-light: #ecf0f1;
            --admin-dark: #2c3e50;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 70vh;
        }
        
        .admin-header {
            background: white;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--admin-accent);
        }
        
        .admin-header h2 {
            margin: 0;
            color: var(--admin-primary);
            font-size: 28px;
        }
        
        .admin-header p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 16px;
        }
        
        .admin-nav {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .admin-nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            flex-wrap: wrap;
        }
        
        .admin-nav li {
            flex: 1;
            min-width: 120px;
        }
        
        .admin-nav-link {
            display: block;
            padding: 20px;
            text-decoration: none;
            color: var(--admin-primary);
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            background: white;
        }
        
        .admin-nav-link:hover {
            background: var(--admin-light);
            color: var(--admin-accent);
        }
        
        .admin-nav-link.active {
            background: var(--admin-accent);
            color: white;
            border-bottom-color: var(--admin-success);
        }
        
        .admin-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .admin-section.active {
            display: block;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: var(--admin-primary);
            font-size: 18px;
        }
        
        .stat-card .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--admin-accent);
            margin: 10px 0;
        }
        
        .stat-card .stat-desc {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        /* Tables */
        .admin-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table thead {
            background: var(--admin-primary);
        }
        
        .admin-table th {
            padding: 18px 20px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 2px solid var(--admin-secondary);
        }
        
        .admin-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        
        .admin-table tbody tr {
            transition: background 0.2s ease;
        }
        
        .admin-table tbody tr:hover {
            background: var(--admin-light);
        }
        
        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-confirmed {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background: var(--admin-accent);
            color: white;
        }
        
        .btn-delete {
            background: var(--admin-danger);
            color: white;
        }
        
        .btn-view {
            background: var(--admin-success);
            color: white;
        }
        
        .btn-confirm {
            background: var(--admin-success);
            color: white;
        }
        
        .btn-cancel {
            background: var(--admin-warning);
            color: white;
        }
        
        .btn-icon:hover {
            opacity: 0.9;
            transform: scale(1.1);
        }
        
        /* Form styles */
        .admin-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--admin-primary);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Alert styles */
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        /* Recent activity */
        .activity-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .activity-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--admin-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-content strong {
            color: var(--admin-primary);
        }
        
        .activity-time {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .admin-nav ul {
                flex-direction: column;
            }
            
            .admin-nav li {
                min-width: 100%;
            }
            
            .admin-nav-link {
                padding: 15px;
                text-align: left;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-table {
                display: block;
                overflow-x: auto;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--admin-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--admin-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* User menu in admin */
        .admin-user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            cursor: pointer;
        }
        
        .admin-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--admin-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .admin-user-info {
            text-align: right;
        }
        
        .admin-user-info .user-name {
            font-weight: 600;
            color: var(--admin-primary);
        }
        
        .admin-user-info .user-role {
            font-size: 13px;
            color: #666;
        }
        
        .admin-user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            overflow: hidden;
        }
        
        .admin-user-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }
        
        .admin-user-dropdown a {
            display: block;
            padding: 12px 20px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .admin-user-dropdown a:hover {
            background: #f5f5f5;
        }
        
        .admin-user-dropdown a:last-child {
            border-bottom: none;
        }
        
        /* Connection status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .connection-online {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .connection-online .status-dot {
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Filter controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-container h3 {
            margin-top: 0;
            color: var(--admin-primary);
        }
        
        /* Content editor */
        .content-editor {
            min-height: 300px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        /* Tab system for content */
        .content-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .content-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }
        
        .content-tab.active {
            color: var(--admin-accent);
            border-bottom-color: var(--admin-accent);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Previsualización de blog */
        .blog-preview {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .blog-preview h1 {
            color: var(--admin-primary);
            margin-bottom: 20px;
        }
        
        .blog-preview .meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        /* Campo de tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-size: 14px;
        }
        
        .tag-input {
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Selector de categorías */
        .category-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .category-option {
            padding: 5px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-option.selected {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }
        
        /* Estilos para reportes */
        .report-preview {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--admin-primary);
            padding-bottom: 15px;
        }
        
        .report-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .report-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        /* Vista previa de imagen de portada */
        .cover-preview {
            max-width: 300px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px dashed #ddd;
        }

        /* Botones generales */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--admin-primary);
            color: white;
        }

        .btn-success {
            background: var(--admin-success);
            color: white;
        }

        .btn-danger {
            background: var(--admin-danger);
            color: white;
        }

        .btn-warning {
            background: var(--admin-warning);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Vista previa de imagen */
        .image-preview-container {
            margin-top: 10px;
            position: relative;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px dashed #ddd;
            padding: 5px;
            background: #f8f9fa;
        }

        /* Campo de precio */
        .price-input {
            position: relative;
        }

        .price-input::before {
            content: "$";
            position: absolute;
            left: 12px;
            top: 12px;
            color: #666;
            font-weight: bold;
        }

        .price-input input {
            padding-left: 30px;
        }
        
        /* Estilos para subida de archivos */
        .file-upload-container {
            margin-top: 10px;
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
        }
        
        .file-upload-label:hover {
            background: #e9ecef;
            border-color: var(--admin-accent);
        }
        
        .file-upload-label i {
            font-size: 24px;
            color: var(--admin-accent);
            margin-bottom: 10px;
            display: block;
        }
        
        .file-upload-input {
            display: none;
        }
        
        .upload-progress {
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--admin-success);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-status {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        /* Opciones de imagen */
        .image-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-option-btn {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .image-option-btn:hover {
            background: #e9ecef;
        }
        
        .image-option-btn.active {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1 class="times-font">Caño <span class="text-orange">Salao</span> - Admin</h1>
                    <div class="connection-status connection-online" id="connection-status">
                        <span class="status-dot"></span>
                        <span id="status-text">Conectando al Backend...</span>
                    </div>
                </div>
                <div class="admin-user-menu">
                    <div class="admin-user-info">
                        <div class="user-name" id="admin-user-name">Administrador</div>
                        <div class="user-role" id="admin-user-role">Cargando...</div>
                    </div>
                    <div class="admin-avatar" id="admin-user-avatar">A</div>
                    <div class="admin-user-dropdown" id="admin-user-dropdown">
                        <a href="../index.html"><i class="bi bi-house"></i> Ver Sitio</a>
                        <a href="usuario.html"><i class="bi bi-person"></i> Panel Usuario</a>
                        <a href="#" id="admin-logout-btn"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header" style="background: linear-gradient(135deg, #1a5276 0%, #2c82c9 100%); color: white; padding: 3rem 0; text-align: center;">
        <div class="container">
            <h1 class="times-font">Panel de Administración Completo</h1>
            <p id="admin-subtitle">Administración de Caño Salao - Sistema de Turismo</p>
        </div>
    </section>

    <!-- Main Content -->
    <main class="page-content" style="padding: 3rem 0; background: #f8f9fa;">
        <div class="admin-container">
            
            <!-- Alert Container -->
            <div id="admin-alert" class="alert" style="display: none;"></div>
            
            <!-- Admin Navigation -->
            <nav class="admin-nav">
                <ul>
                    <li><a href="#" class="admin-nav-link active" data-section="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="users"><i class="bi bi-people"></i> Usuarios</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="tours"><i class="bi bi-signpost"></i> Tours</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="bookings"><i class="bi bi-calendar-check"></i> Reservas</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="blog"><i class="bi bi-newspaper"></i> Blog</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="reports"><i class="bi bi-bar-chart"></i> Reportes</a></li>
                    <li><a href="#" class="admin-nav-link" data-section="settings"><i class="bi bi-gear"></i> Configuración</a></li>
                </ul>
            </nav>

            <!-- ========== DASHBOARD SECTION ========== -->
            <div id="dashboard" class="admin-section active">
                <div class="quick-actions">
                    <button class="btn" onclick="refreshDashboard()" style="background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                    <button class="btn" onclick="showSystemInfo()" style="background: var(--admin-primary);"><i class="bi bi-info-circle"></i> Info Sistema</button>
                    <button class="btn" onclick="testBackendConnection()" style="background: var(--admin-warning);"><i class="bi bi-plug"></i> Probar Conexión</button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="bi bi-people" style="color: var(--admin-accent);"></i>
                        <h3>Usuarios Registrados</h3>
                        <div class="stat-number" id="stat-users">0</div>
                        <p class="stat-desc" id="stat-users-desc">Cargando...</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="bi bi-newspaper" style="color: var(--admin-warning);"></i>
                        <h3>Artículos Blog</h3>
                        <div class="stat-number" id="stat-blog">0</div>
                        <p class="stat-desc" id="stat-blog-desc">Publicados</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="bi bi-signpost" style="color: var(--admin-success);"></i>
                        <h3>Tours Disponibles</h3>
                        <div class="stat-number" id="stat-tours">0</div>
                        <p class="stat-desc" id="stat-tours-desc">Activos</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="bi bi-calendar-check" style="color: var(--admin-primary);"></i>
                        <h3>Reservas Totales</h3>
                        <div class="stat-number" id="stat-bookings">0</div>
                        <p class="stat-desc" id="stat-bookings-desc">Confirmadas</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="form-row">
                    <div class="chart-container" style="flex: 2;">
                        <h3><i class="bi bi-graph-up"></i> Actividad del Sistema</h3>
                        <canvas id="activityChart" height="200"></canvas>
                    </div>
                    <div class="chart-container" style="flex: 1;">
                        <h3><i class="bi bi-pie-chart"></i> Distribución</h3>
                        <canvas id="distributionChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="admin-table-container">
                    <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;"><i class="bi bi-clock-history"></i> Actividad Reciente</h3>
                        <button class="btn" onclick="loadRecentActivity()" style="padding: 8px 15px; font-size: 13px; background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                    </div>
                    <div class="activity-list" id="recent-activity">
                        <div class="activity-item">
                            <div class="activity-icon"><i class="bi bi-gear"></i></div>
                            <div class="activity-content">
                                <strong>Sistema</strong> inicializando panel administrativo
                                <div class="activity-time">Justo ahora</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== USERS SECTION ========== -->
            <div id="users" class="admin-section">
                <div class="quick-actions">
                    <button class="btn" onclick="showAddUserModal()" style="background: var(--admin-success);"><i class="bi bi-person-plus"></i> Agregar Usuario</button>
                    <button class="btn" onclick="loadUsers()" style="background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                    <button class="btn" onclick="exportUsersToCSV()" style="background: var(--admin-primary);"><i class="bi bi-download"></i> Exportar CSV</button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Registro</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p>Cargando usuarios...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== TOURS SECTION ========== -->
            <div id="tours" class="admin-section">
                <div class="quick-actions">
                    <button class="btn" onclick="showAddTourModal()" style="background: var(--admin-success);"><i class="bi bi-plus-circle"></i> Agregar Tour</button>
                    <button class="btn" onclick="loadTours()" style="background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Capacidad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tours-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p>Cargando tours...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== BOOKINGS SECTION ========== -->
            <div id="bookings" class="admin-section">
                <div class="quick-actions">
                    <button class="btn" onclick="loadBookings()" style="background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                    <button class="btn" onclick="exportBookingsToCSV()" style="background: var(--admin-primary);"><i class="bi bi-download"></i> Exportar CSV</button>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Tour</th>
                                <th>Fecha</th>
                                <th>Personas</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p>Cargando reservas...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== BLOG SECTION ========== -->
            <div id="blog" class="admin-section">
                <div class="quick-actions">
                    <button class="btn" onclick="showAddBlogPostModal()" style="background: var(--admin-success);"><i class="bi bi-plus-circle"></i> Nuevo Artículo</button>
                    <button class="btn" onclick="loadBlogPosts()" style="background: var(--admin-accent);"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                    <div class="filter-controls">
                        <select id="blog-filter-category" class="filter-select" onchange="filterBlogPosts()">
                            <option value="all">Todas las categorías</option>
                            <option value="noticias">Noticias</option>
                            <option value="tours">Tours</option>
                            <option value="consejos">Consejos</option>
                            <option value="eventos">Eventos</option>
                        </select>
                        <select id="blog-filter-status" class="filter-select" onchange="filterBlogPosts()">
                            <option value="all">Todos los estados</option>
                            <option value="published">Publicados</option>
                            <option value="draft">Borradores</option>
                        </select>
                    </div>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Categoría</th>
                                <th>Autor</th>
                                <th>Fecha</th>
                                <th>Vistas</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="blog-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p>Cargando artículos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== REPORTS SECTION ========== -->
            <div id="reports" class="admin-section">
                <div class="quick-actions">
                    <button class="btn" onclick="generateDashboardReport()" style="background: var(--admin-success);"><i class="bi bi-file-earmark-pdf"></i> Reporte Dashboard</button>
                    <button class="btn" onclick="generateUsersReport()" style="background: var(--admin-primary);"><i class="bi bi-file-earmark-excel"></i> Reporte Usuarios</button>
                    <button class="btn" onclick="generateBookingsReport()" style="background: var(--admin-accent);"><i class="bi bi-file-earmark-text"></i> Reporte Reservas</button>
                    <button class="btn" onclick="generateFinancialReport()" style="background: var(--admin-warning);"><i class="bi bi-cash-stack"></i> Reporte Financiero</button>
                </div>

                <div class="report-preview" id="report-preview">
                    <div class="report-header">
                        <h2><i class="bi bi-bar-chart"></i> Reporte del Sistema</h2>
                        <p>Selecciona un tipo de reporte para generar</p>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Rango de Fechas</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="report-start-date" class="form-control">
                                <input type="date" id="report-end-date" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Reporte</label>
                            <select id="report-type" class="form-control" onchange="updateReportForm()">
                                <option value="dashboard">Dashboard General</option>
                                <option value="bookings">Reservas Detalladas</option>
                                <option value="financial">Financiero</option>
                                <option value="users">Usuarios</option>
                                <option value="tours">Tours</option>
                            </select>
                        </div>
                    </div>
                    <div id="report-content">
                        <p class="empty-state">No hay datos para mostrar. Genera un reporte.</p>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="generateReport()" style="background: var(--admin-success);"><i class="bi bi-gear"></i> Generar Reporte</button>
                        <button class="btn" onclick="downloadReport()" style="background: var(--admin-primary);"><i class="bi bi-download"></i> Descargar PDF</button>
                        <button class="btn" onclick="exportReportToExcel()" style="background: var(--admin-success);"><i class="bi bi-file-excel"></i> Exportar Excel</button>
                    </div>
                </div>
            </div>

            <!-- ========== SETTINGS SECTION ========== -->
            <div id="settings" class="admin-section">
                <div class="content-tabs">
                    <button class="content-tab active" data-tab="profile">Mi Perfil</button>
                    <button class="content-tab" data-tab="system">Sistema</button>
                    <button class="content-tab" data-tab="backup">Backup</button>
                    <button class="content-tab" data-tab="logs">Logs</button>
                </div>

                <!-- Configuración del perfil -->
                <div id="profile-tab" class="tab-content active">
                    <div class="admin-form">
                        <h3><i class="bi bi-person-circle"></i> Mi Perfil de Administrador</h3>
                        <div id="profile-form-alert" class="alert" style="display: none;"></div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="bi bi-person"></i> Nombre Completo</label>
                                <input type="text" id="profile-name" class="form-control" placeholder="Nombre completo">
                            </div>
                            <div class="form-group">
                                <label><i class="bi bi-envelope"></i> Email</label>
                                <input type="email" id="profile-email" class="form-control" placeholder="correo@ejemplo.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="bi bi-telephone"></i> Teléfono</label>
                                <input type="tel" id="profile-phone" class="form-control" placeholder="+58 412-1234567">
                            </div>
                            <div class="form-group">
                                <label><i class="bi bi-gear"></i> Rol</label>
                                <input type="text" id="profile-role" class="form-control" readonly>
                            </div>
                        </div>
                        <h4 style="margin-top: 30px; color: var(--admin-primary);"><i class="bi bi-lock"></i> Cambiar Contraseña</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contraseña Actual</label>
                                <input type="password" id="current-password" class="form-control" placeholder="Contraseña actual">
                            </div>
                            <div class="form-group">
                                <label>Nueva Contraseña</label>
                                <input type="password" id="new-password" class="form-control" placeholder="Mínimo 6 caracteres">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn" onclick="loadProfile()" style="background: var(--admin-primary);"><i class="bi bi-arrow-clockwise"></i> Recargar</button>
                            <button class="btn" onclick="updateProfile()" style="background: var(--admin-success);"><i class="bi bi-save"></i> Guardar Cambios</button>
                        </div>
                    </div>
                </div>

                <!-- Configuración del sistema -->
                <div id="system-tab" class="tab-content">
                    <div class="admin-form">
                        <h3><i class="bi bi-gear"></i> Configuración del Sistema</h3>
                        <div class="form-group">
                            <label><i class="bi bi-link"></i> URL del Backend</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="backend-url" class="form-control" value="https://cano-salao.onrender.com">
                                <button class="btn" onclick="testBackendConnection()" style="background: var(--admin-warning);"><i class="bi bi-plug"></i> Probar</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="bi bi-clock-history"></i> Auto-refresh</label>
                                <select id="auto-refresh" class="form-control">
                                    <option value="0">Desactivado</option>
                                    <option value="30">30 segundos</option>
                                    <option value="60">1 minuto</option>
                                    <option value="300">5 minutos</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="bi bi-bell"></i> Notificaciones</label>
                                <select id="notifications-level" class="form-control">
                                    <option value="all">Todas</option>
                                    <option value="important">Solo importantes</option>
                                    <option value="none">Ninguna</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifications-enabled" checked>
                                <i class="bi bi-bell"></i> Notificaciones del sistema
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="email-notifications" checked>
                                <i class="bi bi-envelope"></i> Notificaciones por email
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class="btn" onclick="loadSystemSettings()" style="background: var(--admin-primary);"><i class="bi bi-arrow-clockwise"></i> Cargar Configuración</button>
                            <button class="btn" onclick="saveSystemSettings()" style="background: var(--admin-success);"><i class="bi bi-save"></i> Guardar Configuración</button>
                            <button class="btn" onclick="resetSystemSettings()" style="background: var(--admin-danger);"><i class="bi bi-arrow-counterclockwise"></i> Restablecer</button>
                        </div>
                    </div>
                </div>

                <!-- Backup -->
                <div id="backup-tab" class="tab-content">
                    <div class="admin-form">
                        <h3><i class="bi bi-database"></i> Backup del Sistema</h3>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Realiza backup de la base de datos regularmente para prevenir pérdida de datos.
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de Backup</label>
                                <select id="backup-type" class="form-control">
                                    <option value="full">Completo</option>
                                    <option value="users">Solo Usuarios</option>
                                    <option value="tours">Solo Tours</option>
                                    <option value="bookings">Solo Reservas</option>
                                    <option value="blog">Solo Blog</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Formato</label>
                                <select id="backup-format" class="form-control">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="sql">SQL</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn" onclick="createBackup()" style="background: var(--admin-success);"><i class="bi bi-database-check"></i> Crear Backup</button>
                            <button class="btn" onclick="downloadLatestBackup()" style="background: var(--admin-primary);"><i class="bi bi-download"></i> Descargar Último Backup</button>
                            <button class="btn" onclick="showRestoreModal()" style="background: var(--admin-warning);"><i class="bi bi-arrow-clockwise"></i> Restaurar</button>
                        </div>
                    </div>
                </div>

                <!-- Logs -->
                <div id="logs-tab" class="tab-content">
                    <div class="admin-form">
                        <h3><i class="bi bi-journal-text"></i> Logs del Sistema</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de Log</label>
                                <select id="log-type" class="form-control" onchange="loadLogs()">
                                    <option value="all">Todos</option>
                                    <option value="error">Errores</option>
                                    <option value="warning">Advertencias</option>
                                    <option value="info">Información</option>
                                    <option value="login">Inicios de Sesión</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="log-date" class="form-control" onchange="loadLogs()">
                            </div>
                        </div>
                        <div class="admin-table-container">
                            <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0;">Registros del Sistema</h4>
                                <button class="btn" onclick="loadLogs()" style="padding: 5px 10px; font-size: 12px;"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                            <div id="logs-content" style="padding: 20px; max-height: 400px; overflow-y: auto;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Cargando logs...</p>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn" onclick="clearLogs()" style="background: var(--admin-danger);"><i class="bi bi-trash"></i> Limpiar Logs</button>
                            <button class="btn" onclick="exportLogs()" style="background: var(--admin-primary);"><i class="bi bi-download"></i> Exportar Logs</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3 class="times-font"><i class="bi bi-shield-check"></i> Panel Administrativo</h3>
                    <p>Sistema conectado al backend Flask de Caño Salao</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <strong>Versión:</strong> 3.0.0<br>
                        <strong>Backend:</strong> <span id="backend-status">Conectando...</span><br>
                        <strong>Última actualización:</strong> <span id="footer-last-update">--:--:--</span>
                    </p>
                </div>
                <div class="footer-column">
                    <h3 class="times-font"><i class="bi bi-lightning"></i> Acciones Rápidas</h3>
                    <ul class="footer-links">
                        <li><a href="#" onclick="showSection('users')"><i class="bi bi-people"></i> Gestionar Usuarios</a></li>
                        <li><a href="#" onclick="showSection('tours')"><i class="bi bi-signpost"></i> Gestionar Tours</a></li>
                        <li><a href="#" onclick="showSection('bookings')"><i class="bi bi-calendar-check"></i> Ver Reservas</a></li>
                        <li><a href="#" onclick="showSection('blog')"><i class="bi bi-newspaper"></i> Blog</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3 class="times-font"><i class="bi bi-database"></i> Sistema</h3>
                    <p><strong>Usuarios cargados:</strong> <span id="footer-users-count">0</span></p>
                    <p><strong>Tours cargados:</strong> <span id="footer-tours-count">0</span></p>
                    <p><strong>Token válido:</strong> <span id="footer-token-valid">No</span></p>
                </div>
            </div>
            <div class="copyright">
                <p><i class="bi bi-c-circle"></i> 2024 Caño Salao - Panel Administrativo</p>
                <p style="font-size: 11px; color: #888;"><i class="bi bi-code-slash"></i> Conectado al Backend Flask | <span id="current-time">--:--:--</span></p>
            </div>
        </div>
    </footer>

    <!-- ========== MODALES ========== -->
    
    <!-- Modal Agregar Usuario -->
    <div id="modal-add-user" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-person-plus"></i> Agregar Nuevo Usuario</h3>
                <button class="modal-close" onclick="closeModal('modal-add-user')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="add-user-alert" class="alert" style="display: none;"></div>
                <form id="add-user-form">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="new-user-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="new-user-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" id="new-user-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Teléfono (opcional)</label>
                        <input type="tel" id="new-user-phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="new-user-role" class="form-control">
                            <option value="user">Usuario Normal</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-user')">Cancelar</button>
                <button class="btn" onclick="addNewUser()" style="background: var(--admin-success);">Crear Usuario</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Usuario -->
    <div id="modal-edit-user" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-person-gear"></i> Editar Usuario</h3>
                <button class="modal-close" onclick="closeModal('modal-edit-user')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-user-alert" class="alert" style="display: none;"></div>
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="edit-user-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-user-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="edit-user-phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="edit-user-role" class="form-control">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="edit-user-status" class="form-control">
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-edit-user')">Cancelar</button>
                <button class="btn" onclick="saveUserEdit()" style="background: var(--admin-success);">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Tour -->
    <div id="modal-add-tour" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-signpost"></i> Agregar Nuevo Tour</h3>
                <button class="modal-close" onclick="closeModal('modal-add-tour')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="add-tour-alert" class="alert" style="display: none;"></div>
                <form id="add-tour-form">
                    <div class="form-group">
                        <label>Nombre del Tour</label>
                        <input type="text" id="new-tour-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea id="new-tour-desc" class="form-control" rows="4" required placeholder="Describe el tour detalladamente..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio ($)</label>
                            <div class="price-input">
                                <input type="number" id="new-tour-price" class="form-control" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Capacidad</label>
                            <input type="number" id="new-tour-capacity" class="form-control" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duración</label>
                            <input type="text" id="new-tour-duration" class="form-control" placeholder="Ej: 2 horas" required>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="new-tour-available" class="form-control">
                                <option value="true">Disponible</option>
                                <option value="false">No Disponible</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Imagen del Tour</label>
                        <div class="image-options">
                            <button type="button" class="image-option-btn active" onclick="toggleImageOption('upload')">Subir imagen</button>
                            <button type="button" class="image-option-btn" onclick="toggleImageOption('url')">Usar URL</button>
                        </div>
                        
                        <div id="image-upload-section">
                            <label class="file-upload-label" for="tour-image-upload">
                                <i class="bi bi-cloud-upload"></i>
                                <span>Haz clic para subir una imagen</span>
                                <span style="font-size: 12px; color: #666;">(JPEG, PNG, GIF - Máx. 5MB)</span>
                            </label>
                            <input type="file" id="tour-image-upload" class="file-upload-input" accept="image/*">
                            <div class="upload-progress" id="tour-upload-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="tour-progress-fill"></div>
                                </div>
                                <div class="upload-status" id="tour-upload-status">0%</div>
                            </div>
                        </div>
                        
                        <div id="image-url-section" style="display: none;">
                            <input type="url" id="new-tour-image-url" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                        
                        <div class="image-preview-container">
                            <img id="tour-image-preview" class="image-preview" style="display: none;" alt="Vista previa">
                            <input type="hidden" id="tour-image-data">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-tour')">Cancelar</button>
                <button class="btn" onclick="addNewTour()" style="background: var(--admin-success);">Crear Tour</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Tour -->
    <div id="modal-edit-tour" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-signpost"></i> Editar Tour</h3>
                <button class="modal-close" onclick="closeModal('modal-edit-tour')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-tour-alert" class="alert" style="display: none;"></div>
                <form id="edit-tour-form">
                    <input type="hidden" id="edit-tour-id">
                    <div class="form-group">
                        <label>Nombre del Tour</label>
                        <input type="text" id="edit-tour-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea id="edit-tour-desc" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio ($)</label>
                            <div class="price-input">
                                <input type="number" id="edit-tour-price" class="form-control" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Capacidad</label>
                            <input type="number" id="edit-tour-capacity" class="form-control" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duración</label>
                            <input type="text" id="edit-tour-duration" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="edit-tour-available" class="form-control">
                                <option value="true">Disponible</option>
                                <option value="false">No Disponible</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Imagen del Tour</label>
                        <div class="image-options">
                            <button type="button" class="image-option-btn active" onclick="toggleEditImageOption('upload')">Subir imagen</button>
                            <button type="button" class="image-option-btn" onclick="toggleEditImageOption('url')">Usar URL</button>
                        </div>
                        
                        <div id="edit-image-upload-section">
                            <label class="file-upload-label" for="edit-tour-image-upload">
                                <i class="bi bi-cloud-upload"></i>
                                <span>Haz clic para subir una nueva imagen</span>
                                <span style="font-size: 12px; color: #666;">(JPEG, PNG, GIF - Máx. 5MB)</span>
                            </label>
                            <input type="file" id="edit-tour-image-upload" class="file-upload-input" accept="image/*">
                            <div class="upload-progress" id="edit-tour-upload-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="edit-tour-progress-fill"></div>
                                </div>
                                <div class="upload-status" id="edit-tour-upload-status">0%</div>
                            </div>
                        </div>
                        
                        <div id="edit-image-url-section" style="display: none;">
                            <input type="url" id="edit-tour-image-url" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                        
                        <div class="image-preview-container">
                            <img id="edit-tour-image-preview" class="image-preview" style="display: none;" alt="Vista previa">
                            <input type="hidden" id="edit-tour-image-data">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-edit-tour')">Cancelar</button>
                <button class="btn" onclick="saveTourEdit()" style="background: var(--admin-success);">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Artículo de Blog -->
    <div id="modal-add-blog" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="bi bi-pencil-square"></i> Nuevo Artículo de Blog</h3>
                <button class="modal-close" onclick="closeModal('modal-add-blog')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="add-blog-alert" class="alert" style="display: none;"></div>
                <div class="form-group">
                    <label>Título del Artículo *</label>
                    <input type="text" id="blog-title" class="form-control" placeholder="Ej: Nuevo tour por los manglares" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categoría *</label>
                        <select id="blog-category" class="form-control" required>
                            <option value="noticias">Noticias</option>
                            <option value="tours">Tours</option>
                            <option value="consejos">Consejos</option>
                            <option value="eventos">Eventos</option>
                            <option value="fauna">Fauna</option>
                            <option value="flora">Flora</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Autor *</label>
                        <input type="text" id="blog-author" class="form-control" placeholder="Nombre del autor" required value="Administrador">
                    </div>
                </div>
                <div class="form-group">
                    <label>Imagen Principal</label>
                    <div class="image-options">
                        <button type="button" class="image-option-btn active" onclick="toggleBlogImageOption('upload')">Subir imagen</button>
                        <button type="button" class="image-option-btn" onclick="toggleBlogImageOption('url')">Usar URL</button>
                    </div>
                    
                    <div id="blog-image-upload-section">
                        <label class="file-upload-label" for="blog-image-upload">
                            <i class="bi bi-cloud-upload"></i>
                            <span>Haz clic para subir una imagen</span>
                            <span style="font-size: 12px; color: #666;">(JPEG, PNG, GIF - Máx. 5MB)</span>
                        </label>
                        <input type="file" id="blog-image-upload" class="file-upload-input" accept="image/*">
                        <div class="upload-progress" id="blog-upload-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="blog-progress-fill"></div>
                            </div>
                            <div class="upload-status" id="blog-upload-status">0%</div>
                        </div>
                    </div>
                    
                    <div id="blog-image-url-section" style="display: none;">
                        <input type="url" id="blog-image-url" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    
                    <div class="image-preview-container">
                        <img id="blog-image-preview" class="image-preview" style="display: none;" alt="Vista previa">
                        <input type="hidden" id="blog-image-data">
                    </div>
                </div>
                <div class="form-group">
                    <label>Resumen (excerpt)</label>
                    <textarea id="blog-excerpt" class="form-control" rows="3" placeholder="Breve resumen que aparecerá en la lista de artículos"></textarea>
                </div>
                <div class="form-group">
                    <label>Contenido *</label>
                    <textarea id="blog-content-textarea" class="form-control" rows="10" placeholder="Escribe el contenido del artículo aquí..." required></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="blog-published" checked>
                        Publicar inmediatamente
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-blog')">Cancelar</button>
                <button class="btn" onclick="saveBlogPost()" style="background: var(--admin-success);"><i class="bi bi-save"></i> Publicar Artículo</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Artículo de Blog -->
    <div id="modal-edit-blog" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="bi bi-pencil-square"></i> Editar Artículo de Blog</h3>
                <button class="modal-close" onclick="closeModal('modal-edit-blog')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-blog-alert" class="alert" style="display: none;"></div>
                <input type="hidden" id="edit-blog-id">
                <div class="form-group">
                    <label>Título del Artículo *</label>
                    <input type="text" id="edit-blog-title" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categoría *</label>
                        <select id="edit-blog-category" class="form-control" required>
                            <option value="noticias">Noticias</option>
                            <option value="tours">Tours</option>
                            <option value="consejos">Consejos</option>
                            <option value="eventos">Eventos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Autor *</label>
                        <input type="text" id="edit-blog-author" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Imagen Principal</label>
                    <div class="image-options">
                        <button type="button" class="image-option-btn active" onclick="toggleEditBlogImageOption('upload')">Subir imagen</button>
                            <button type="button" class="image-option-btn" onclick="toggleEditBlogImageOption('url')">Usar URL</button>
                        </div>
                        
                        <div id="edit-blog-image-upload-section">
                            <label class="file-upload-label" for="edit-blog-image-upload">
                                <i class="bi bi-cloud-upload"></i>
                                <span>Haz clic para subir una nueva imagen</span>
                                <span style="font-size: 12px; color: #666;">(JPEG, PNG, GIF - Máx. 5MB)</span>
                            </label>
                            <input type="file" id="edit-blog-image-upload" class="file-upload-input" accept="image/*">
                            <div class="upload-progress" id="edit-blog-upload-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="edit-blog-progress-fill"></div>
                                </div>
                                <div class="upload-status" id="edit-blog-upload-status">0%</div>
                            </div>
                        </div>
                        
                        <div id="edit-blog-image-url-section" style="display: none;">
                            <input type="url" id="edit-blog-image-url" class="form-control">
                        </div>
                        
                        <div class="image-preview-container">
                            <img id="edit-blog-image-preview" class="image-preview" style="display: none;" alt="Vista previa">
                            <input type="hidden" id="edit-blog-image-data">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Resumen (excerpt)</label>
                        <textarea id="edit-blog-excerpt" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Contenido *</label>
                        <textarea id="edit-blog-content-textarea" class="form-control" rows="10" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-blog-published">
                            Publicado
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal('modal-edit-blog')">Cancelar</button>
                    <button class="btn" onclick="saveBlogEdit()" style="background: var(--admin-success);"><i class="bi bi-save"></i> Guardar Cambios</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Ver/Editar Reserva -->
        <div id="modal-booking" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="bi bi-calendar-check"></i> Detalles de Reserva</h3>
                    <button class="modal-close" onclick="closeModal('modal-booking')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="booking-alert" class="alert" style="display: none;"></div>
                    <form id="booking-form">
                        <input type="hidden" id="booking-id">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="booking-user" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Tour</label>
                            <input type="text" id="booking-tour" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="booking-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Número de Personas</label>
                            <input type="number" id="booking-people" class="form-control" min="1">
                        </div>
                        <div class="form-group">
                            <label>Total ($)</label>
                            <input type="number" id="booking-total" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="booking-status" class="form-control">
                                <option value="pending">Pendiente</option>
                                <option value="confirmed">Confirmada</option>
                                <option value="cancelled">Cancelada</option>
                                <option value="completed">Completada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="booking-notes" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal('modal-booking')">Cancelar</button>
                    <button class="btn btn-success" onclick="saveBooking()">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal Confirmación -->
        <div id="modal-confirm" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3><i class="bi bi-exclamation-triangle"></i> Confirmar</h3>
                    <button class="modal-close" onclick="closeModal('modal-confirm')">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">¿Estás seguro de realizar esta acción?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal('modal-confirm')">Cancelar</button>
                    <button class="btn btn-danger" id="confirm-action-btn">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal Restaurar Backup -->
        <div id="modal-restore" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="bi bi-arrow-clockwise"></i> Restaurar Backup</h3>
                    <button class="modal-close" onclick="closeModal('modal-restore')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="restore-alert" class="alert" style="display: none;"></div>
                    <div class="form-group">
                        <label>Seleccionar Archivo de Backup</label>
                        <input type="file" id="backup-file" class="form-control" accept=".json,.csv,.sql">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Restauración</label>
                        <select id="restore-type" class="form-control">
                            <option value="full">Restauración Completa</option>
                            <option value="partial">Restauración Parcial</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Advertencia:</strong> La restauración completa sobrescribirá todos los datos actuales.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal('modal-restore')">Cancelar</button>
                    <button class="btn btn-warning" onclick="restoreBackup()">Restaurar</button>
                </div>
            </div>
        </div>

        <!-- Vista Previa Blog -->
        <div id="modal-preview-blog" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3><i class="bi bi-eye"></i> Vista Previa del Artículo</h3>
                    <button class="modal-close" onclick="closeModal('modal-preview-blog')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="blog-preview-content"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal('modal-preview-blog')">Cerrar</button>
                </div>
            </div>
        </div>

<!-- SCRIPT PRINCIPAL COMPLETO CON TODAS LAS FUNCIONALIDADES -->
<script>
    // ========== CONFIGURACIÓN ==========
    const API_BASE_URL = 'https://cano-salao.onrender.com';
    const STORAGE_KEYS = {
        TOKEN: 'cano_salao_token',
        REFRESH_TOKEN: 'cano_salao_refresh_token',
        USER: 'cano_salao_user',
        SETTINGS: 'admin_settings'
    };
    
    // ========== ESTADO GLOBAL ==========
    let currentUser = null;
    let token = localStorage.getItem(STORAGE_KEYS.TOKEN);
    let isAdmin = false;
    let autoRefreshInterval = null;
    let toursData = [];
    let blogPostsData = [];
    let allBlogPosts = [];
    let allBookings = [];
    let allUsers = [];
    
    // Variables para manejo de imágenes
    let currentImageOption = 'upload';
    let currentBlogImageOption = 'upload';
    let currentEditImageOption = 'upload';
    let currentEditBlogImageOption = 'upload';
    
    // Variables para reportes
    let currentReportData = null;
    let reportChart = null;
    
    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Inicializando Panel Administrativo Completo...');
        
        // Configurar fechas para reportes
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        document.getElementById('report-start-date').value = lastMonth.toISOString().split('T')[0];
        document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
        document.getElementById('log-date').value = today.toISOString().split('T')[0];
        
        // Inicializar UI
        initNavigation();
        initTabs();
        initUserMenu();
        initEventListeners();
        initImageUploads();
        
        // Verificar conexión y permisos
        await testBackendConnection();
        await checkAuthAndAdmin();
        
        // Iniciar timers
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // Cargar configuración guardada
        loadSavedSettings();
        
        console.log('✅ Panel inicializado correctamente');
    });
    
    function initImageUploads() {
        // Inicializar eventos para subida de imágenes
        const tourImageUpload = document.getElementById('tour-image-upload');
        const editTourImageUpload = document.getElementById('edit-tour-image-upload');
        const blogImageUpload = document.getElementById('blog-image-upload');
        const editBlogImageUpload = document.getElementById('edit-blog-image-upload');
        
        if (tourImageUpload) {
            tourImageUpload.addEventListener('change', function(e) {
                handleImageUpload(e, 'tour-image-preview', 'tour-image-data', 'tour-upload-progress', 'tour-progress-fill', 'tour-upload-status');
            });
        }
        
        if (editTourImageUpload) {
            editTourImageUpload.addEventListener('change', function(e) {
                handleImageUpload(e, 'edit-tour-image-preview', 'edit-tour-image-data', 'edit-tour-upload-progress', 'edit-tour-progress-fill', 'edit-tour-upload-status');
            });
        }
        
        if (blogImageUpload) {
            blogImageUpload.addEventListener('change', function(e) {
                handleImageUpload(e, 'blog-image-preview', 'blog-image-data', 'blog-upload-progress', 'blog-progress-fill', 'blog-upload-status');
            });
        }
        
        if (editBlogImageUpload) {
            editBlogImageUpload.addEventListener('change', function(e) {
                handleImageUpload(e, 'edit-blog-image-preview', 'edit-blog-image-data', 'edit-blog-upload-progress', 'edit-blog-progress-fill', 'edit-blog-upload-status');
            });
        }
    }
    
    function initEventListeners() {
        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // Cerrar con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
        
        // Previsualización de URLs en tiempo real
        const urlInputs = [
            { input: 'blog-image-url', preview: 'blog-image-preview' },
            { input: 'edit-blog-image-url', preview: 'edit-blog-image-preview' },
            { input: 'new-tour-image-url', preview: 'tour-image-preview' },
            { input: 'edit-tour-image-url', preview: 'edit-tour-image-preview' }
        ];
        
        urlInputs.forEach(item => {
            const input = document.getElementById(item.input);
            const preview = document.getElementById(item.preview);
            if (input && preview) {
                input.addEventListener('input', function() {
                    updateImagePreviewFromUrl(this.value, preview);
                });
            }
        });
    }
    
    // ========== FUNCIONES PARA SUBIDA DE IMÁGENES ==========
    function toggleImageOption(option) {
        currentImageOption = option;
        const uploadSection = document.getElementById('image-upload-section');
        const urlSection = document.getElementById('image-url-section');
        const buttons = document.querySelectorAll('#modal-add-tour .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (option === 'upload') {
            uploadSection.style.display = 'block';
            urlSection.style.display = 'none';
        } else {
            uploadSection.style.display = 'none';
            urlSection.style.display = 'block';
        }
    }
    
    function toggleEditImageOption(option) {
        currentEditImageOption = option;
        const uploadSection = document.getElementById('edit-image-upload-section');
        const urlSection = document.getElementById('edit-image-url-section');
        const buttons = document.querySelectorAll('#modal-edit-tour .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (option === 'upload') {
            uploadSection.style.display = 'block';
            urlSection.style.display = 'none';
        } else {
            uploadSection.style.display = 'none';
            urlSection.style.display = 'block';
        }
    }
    
    function toggleBlogImageOption(option) {
        currentBlogImageOption = option;
        const uploadSection = document.getElementById('blog-image-upload-section');
        const urlSection = document.getElementById('blog-image-url-section');
        const buttons = document.querySelectorAll('#modal-add-blog .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (option === 'upload') {
            uploadSection.style.display = 'block';
            urlSection.style.display = 'none';
        } else {
            uploadSection.style.display = 'none';
            urlSection.style.display = 'block';
        }
    }
    
    function toggleEditBlogImageOption(option) {
        currentEditBlogImageOption = option;
        const uploadSection = document.getElementById('edit-blog-image-upload-section');
        const urlSection = document.getElementById('edit-blog-image-url-section');
        const buttons = document.querySelectorAll('#modal-edit-blog .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (option === 'upload') {
            uploadSection.style.display = 'block';
            urlSection.style.display = 'none';
        } else {
            uploadSection.style.display = 'none';
            urlSection.style.display = 'block';
        }
    }
    
    function handleImageUpload(event, previewId, dataInputId, progressId, progressFillId, statusId) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validar tamaño (5MB máximo)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('La imagen es demasiado grande. El tamaño máximo es 5MB.', 'error');
            return;
        }
        
        // Validar tipo
        if (!file.type.match('image.*')) {
            showAlert('Por favor, selecciona una imagen válida (JPEG, PNG, GIF).', 'error');
            return;
        }
        
        const reader = new FileReader();
        const preview = document.getElementById(previewId);
        const dataInput = document.getElementById(dataInputId);
        const progressElement = document.getElementById(progressId);
        const progressFill = document.getElementById(progressFillId);
        const statusElement = document.getElementById(statusId);
        
        // Mostrar barra de progreso
        progressElement.style.display = 'block';
        progressFill.style.width = '0%';
        statusElement.textContent = '0%';
        
        reader.onloadstart = function() {
            progressFill.style.width = '10%';
            statusElement.textContent = '10%';
        };
        
        reader.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentLoaded = Math.round((e.loaded / e.total) * 100);
                progressFill.style.width = percentLoaded + '%';
                statusElement.textContent = percentLoaded + '%';
            }
        };
        
        reader.onload = function(e) {
            progressFill.style.width = '100%';
            statusElement.textContent = '100%';
            
            // Mostrar vista previa
            preview.src = e.target.result;
            preview.style.display = 'block';
            
            // Guardar datos de la imagen
            dataInput.value = e.target.result;
            
            // Ocultar barra de progreso después de un momento
            setTimeout(() => {
                progressElement.style.display = 'none';
            }, 1000);
        };
        
        reader.onerror = function() {
            showAlert('Error al cargar la imagen.', 'error');
            progressElement.style.display = 'none';
        };
        
        reader.readAsDataURL(file);
    }
    
    function updateImagePreviewFromUrl(url, previewId) {
        const preview = document.getElementById(previewId);
        if (url && isValidUrl(url)) {
            preview.src = url;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }
    
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }
    
    // ========== SISTEMA DE AUTENTICACIÓN ==========
    async function checkAuthAndAdmin() {
        if (!token) {
            showAlert('Por favor inicia sesión primero', 'error');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return false;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    
                    if (currentUser.rol !== 'admin') {
                        showAlert('Acceso solo para administradores', 'error');
                        setTimeout(() => window.location.href = '../index.html', 2000);
                        return false;
                    }
                    
                    isAdmin = true;
                    updateUserUI();
                    loadInitialData();
                    return true;
                }
            } else if (response.status === 401) {
                const refreshed = await refreshAuthToken();
                if (refreshed) {
                    return checkAuthAndAdmin();
                } else {
                    showAlert('Sesión expirada', 'error');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return false;
                }
            }
        } catch (error) {
            console.error('Error verificando permisos:', error);
            showAlert('Error de conexión con el servidor', 'error');
            return false;
        }
    }
    
    async function refreshAuthToken() {
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        if (!refreshToken) return null;
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${refreshToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                localStorage.setItem(STORAGE_KEYS.TOKEN, data.access_token);
                token = data.access_token;
                return true;
            }
        } catch (error) {
            console.error('Error refrescando token:', error);
        }
        return false;
    }
    
    function updateUserUI() {
        if (!currentUser) return;
        
        document.getElementById('admin-user-name').textContent = currentUser.nombre || 'Administrador';
        document.getElementById('admin-user-role').textContent = currentUser.rol === 'admin' ? 'Administrador' : 'Usuario';
        document.getElementById('admin-user-avatar').textContent = (currentUser.nombre?.charAt(0) || 'A').toUpperCase();
        document.getElementById('admin-subtitle').textContent = `Bienvenido, ${currentUser.nombre}`;
        
        // Establecer autor por defecto en formularios de blog
        document.getElementById('blog-author').value = currentUser.nombre || 'Administrador';
    }
    
    function initUserMenu() {
        const avatar = document.getElementById('admin-user-avatar');
        const dropdown = document.getElementById('admin-user-dropdown');
        const logoutBtn = document.getElementById('admin-logout-btn');
        
        if (avatar) {
            avatar.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });
        }
        
        document.addEventListener('click', function(e) {
            if (!avatar?.contains(e.target) && !dropdown?.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
        }
    }
    
    function logout() {
        if (confirm('¿Estás seguro de cerrar sesión?')) {
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            window.location.href = 'login.html';
        }
    }
    
    // ========== NAVEGACIÓN Y UI ==========
    function initNavigation() {
        document.querySelectorAll('.admin-nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId);
            });
        });
    }
    
    function initTabs() {
        document.querySelectorAll('.content-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Cargar datos según la pestaña
                if (tabId === 'logs') {
                    loadLogs();
                }
            });
        });
    }
    
    function showSection(sectionId) {
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            
            if (isAdmin) {
                switch(sectionId) {
                    case 'dashboard': loadDashboardData(); break;
                    case 'users': loadUsers(); break;
                    case 'tours': loadTours(); break;
                    case 'bookings': loadBookings(); break;
                    case 'blog': loadBlogPosts(); break;
                    case 'settings': loadProfile(); loadSystemSettings(); break;
                    case 'reports': updateReportForm(); break;
                }
            }
        }
    }
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Resetear formularios y vistas previas
            resetModalForms(modalId);
        }
    }
    
    function resetModalForms(modalId) {
        if (modalId === 'modal-add-blog') {
            document.getElementById('blog-title').value = '';
            document.getElementById('blog-author').value = currentUser?.nombre || 'Administrador';
            document.getElementById('blog-excerpt').value = '';
            document.getElementById('blog-image-url').value = '';
            document.getElementById('blog-content-textarea').value = '';
            document.getElementById('blog-published').checked = true;
            document.getElementById('blog-image-preview').style.display = 'none';
            document.getElementById('blog-image-data').value = '';
            document.getElementById('blog-upload-progress').style.display = 'none';
        }
    }
    
    function showAlert(message, type = 'info') {
        const alertDiv = document.getElementById('admin-alert');
        if (!alertDiv) return;
        
        alertDiv.innerHTML = message;
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.display = 'block';
        
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }
    
    function showModalAlert(modalId, message, type) {
        const alertDiv = document.getElementById(modalId);
        if (!alertDiv) return;
        
        alertDiv.textContent = message;
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.display = 'block';
        
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }
    
    function confirmAction(message, callback) {
        document.getElementById('confirm-message').textContent = message;
        const confirmBtn = document.getElementById('confirm-action-btn');
        
        confirmBtn.onclick = function() {
            callback();
            closeModal('modal-confirm');
        };
        
        openModal('modal-confirm');
    }
    
    // ========== CONEXIÓN CON BACKEND ==========
    async function testBackendConnection() {
        const statusElement = document.getElementById('backend-status');
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        
        statusElement.textContent = 'Probando...';
        statusElement.style.color = '#f39c12';
        connectionStatus.className = 'connection-status connection-offline';
        statusText.textContent = 'Probando conexión...';
        
        try {
            const response = await fetch(`${API_BASE_URL}/health`);
            
            if (response.ok) {
                const data = await response.json();
                
                statusElement.textContent = 'Conectado ✓';
                statusElement.style.color = '#27ae60';
                connectionStatus.className = 'connection-status connection-online';
                statusText.textContent = 'Conectado al Backend';
                
                showAlert(`✅ Backend conectado: ${data.database}`, 'success');
                return true;
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error conectando al backend:', error);
            
            statusElement.textContent = 'Desconectado ✗';
            statusElement.style.color = '#e74c3c';
            connectionStatus.className = 'connection-status connection-offline';
            statusText.textContent = 'Error de conexión';
            
            showAlert(`❌ No se pudo conectar al backend: ${error.message}`, 'error');
            return false;
        }
    }
    
    // ========== DATOS INICIALES ==========
    function loadInitialData() {
        loadDashboardData();
        loadRecentActivity();
    }
    
    function loadSavedSettings() {
        const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                if (settings.autoRefresh) {
                    document.getElementById('auto-refresh').value = settings.autoRefresh;
                    setupAutoRefresh(settings.autoRefresh);
                }
                if (settings.notificationsEnabled !== undefined) {
                    document.getElementById('notifications-enabled').checked = settings.notificationsEnabled;
                }
                if (settings.emailNotifications !== undefined) {
                    document.getElementById('email-notifications').checked = settings.emailNotifications;
                }
                if (settings.notificationsLevel) {
                    document.getElementById('notifications-level').value = settings.notificationsLevel;
                }
                if (settings.backendUrl) {
                    document.getElementById('backend-url').value = settings.backendUrl;
                }
            } catch (e) {
                console.error('Error cargando configuración:', e);
            }
        }
    }
    
    function setupAutoRefresh(seconds) {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        if (seconds > 0) {
            autoRefreshInterval = setInterval(() => {
                const activeSection = document.querySelector('.admin-section.active');
                if (activeSection) {
                    switch(activeSection.id) {
                        case 'dashboard': loadDashboardData(); break;
                        case 'users': loadUsers(); break;
                        case 'tours': loadTours(); break;
                        case 'bookings': loadBookings(); break;
                        case 'blog': loadBlogPosts(); break;
                    }
                }
            }, seconds * 1000);
        }
    }
    
    // ========== DASHBOARD ==========
    async function loadDashboardData() {
        if (!token || !isAdmin) return;
        
        try {
            // Cargar estadísticas en paralelo
            const [usersRes, toursRes, bookingsRes, blogRes] = await Promise.allSettled([
                fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }),
                fetch(`${API_BASE_URL}/api/tours`),
                fetch(`${API_BASE_URL}/api/admin/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }),
                fetch(`${API_BASE_URL}/api/blog`)
            ]);
            
            // Procesar resultados
            let stats = {
                total_users: 0,
                active_users: 0,
                total_blog_posts: 0,
                total_tours: 0,
                active_tours: 0,
                total_bookings: 0,
                pending_bookings: 0,
                recent_registrations: 0
            };
            
            // Usuarios
            if (usersRes.status === 'fulfilled' && usersRes.value.ok) {
                const users = await usersRes.value.json();
                stats.total_users = users.length;
                stats.active_users = users.filter(u => u.activo).length;
            }
            
            // Tours
            if (toursRes.status === 'fulfilled' && toursRes.value.ok) {
                const tours = await toursRes.value.json();
                stats.total_tours = tours.length;
                stats.active_tours = tours.filter(t => t.disponible).length;
            }
            
            // Reservas
            if (bookingsRes.status === 'fulfilled' && bookingsRes.value.ok) {
                const bookings = await bookingsRes.value.json();
                stats.total_bookings = bookings.length;
                stats.pending_bookings = bookings.filter(b => b.estado === 'pending').length;
            }
            
            // Blog
            if (blogRes.status === 'fulfilled' && blogRes.value.ok) {
                const blogPosts = await blogRes.value.json();
                stats.total_blog_posts = blogPosts.length;
            }
            
            updateDashboardStats(stats);
            initCharts(stats);
            updateFooterStats(stats);
            
        } catch (error) {
            console.error('Error cargando dashboard:', error);
        }
    }
    
    function updateDashboardStats(stats) {
        if (!stats) return;
        
        document.getElementById('stat-users').textContent = stats.total_users || 0;
        document.getElementById('stat-users-desc').textContent = `${stats.active_users || 0} activos`;
        
        document.getElementById('stat-blog').textContent = stats.total_blog_posts || 0;
        document.getElementById('stat-tours').textContent = stats.total_tours || 0;
        document.getElementById('stat-tours-desc').textContent = `${stats.active_tours || 0} activos`;
        
        document.getElementById('stat-bookings').textContent = stats.total_bookings || 0;
        document.getElementById('stat-bookings-desc').textContent = `${stats.pending_bookings || 0} pendientes`;
    }
    
    function updateFooterStats(stats) {
        if (!stats) return;
        
        document.getElementById('footer-users-count').textContent = stats.total_users || 0;
        document.getElementById('footer-tours-count').textContent = stats.total_tours || 0;
        document.getElementById('footer-token-valid').textContent = 'Sí';
        document.getElementById('footer-last-update').textContent = new Date().toLocaleTimeString();
    }
    
    function initCharts(stats) {
        const ctx1 = document.getElementById('activityChart')?.getContext('2d');
        const ctx2 = document.getElementById('distributionChart')?.getContext('2d');
        
        if (ctx1 && Chart) {
            if (window.activityChart) {
                window.activityChart.destroy();
            }
            
            // Datos para el gráfico de actividad (últimos 7 días)
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('es-ES', { weekday: 'short' }));
                // Datos simulados - en producción deberías obtener datos reales
                data.push(Math.floor(Math.random() * 20) + 5);
            }
            
            window.activityChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Actividad',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    }
                }
            });
        }
        
        if (ctx2 && Chart) {
            if (window.distributionChart) {
                window.distributionChart.destroy();
            }
            
            window.distributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Usuarios', 'Tours', 'Reservas', 'Blog'],
                    datasets: [{
                        data: [
                            stats.total_users || 0,
                            stats.total_tours || 0,
                            stats.total_bookings || 0,
                            stats.total_blog_posts || 0
                        ],
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12'],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    }
    
    function refreshDashboard() {
        loadDashboardData();
        loadRecentActivity();
        showAlert('Dashboard actualizado', 'success');
    }
    
    function loadRecentActivity() {
        const activityList = document.getElementById('recent-activity');
        
        // Datos simulados - en producción deberías obtener datos reales de logs
        const activities = [
            { icon: 'bi-person-plus', user: currentUser?.nombre || 'Admin', action: 'actualizó el dashboard', time: 'Hace 5 minutos' },
            { icon: 'bi-signpost', user: 'Sistema', action: 'cargó datos de tours', time: 'Hace 10 minutos' },
            { icon: 'bi-calendar-check', user: 'Sistema', action: 'sincronizó reservas', time: 'Hace 15 minutos' },
            { icon: 'bi-newspaper', user: currentUser?.nombre || 'Admin', action: 'publicó un artículo en el blog', time: 'Hace 2 horas' },
            { icon: 'bi-people', user: 'Sistema', action: 'registró un nuevo usuario', time: 'Hace 3 horas' }
        ];
        
        activityList.innerHTML = '';
        activities.forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon"><i class="bi ${activity.icon}"></i></div>
                <div class="activity-content">
                    <strong>${activity.user}</strong> ${activity.action}
                    <div class="activity-time">${activity.time}</div>
                </div>
            `;
            activityList.appendChild(item);
        });
    }
    
    function showSystemInfo() {
        const info = `
            <strong><i class="bi bi-info-circle"></i> Información del Sistema:</strong><br><br>
            • Backend: ${API_BASE_URL}<br>
            • Usuario: ${currentUser?.nombre || 'No cargado'}<br>
            • Email: ${currentUser?.email || 'No cargado'}<br>
            • Rol: ${currentUser?.rol || 'Desconocido'}<br>
            • Es administrador: ${isAdmin ? 'Sí' : 'No'}<br>
            • Token válido: ${token ? 'Sí' : 'No'}<br>
            • Auto-refresh: ${document.getElementById('auto-refresh').value} segundos<br>
            • Última conexión: ${new Date().toLocaleTimeString()}
        `;
        
        showAlert(info, 'info');
    }
    
    // ========== USUARIOS ==========
    async function loadUsers() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                allUsers = await response.json();
                renderUsersTable(allUsers);
            } else {
                throw new Error('Error cargando usuarios');
            }
        } catch (error) {
            console.error('Error cargando usuarios:', error);
            showAlert('Error cargando usuarios', 'error');
            renderEmptyUsersTable();
        }
    }
    
    function renderUsersTable(users) {
        const tbody = document.getElementById('users-table-body');
        if (!tbody) return;
        
        if (!users || users.length === 0) {
            renderEmptyUsersTable();
            return;
        }
        
        tbody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td><strong>${user.nombre}</strong></td>
                <td>${user.email}</td>
                <td><span class="status-badge ${user.rol === 'admin' ? 'status-active' : 'status-pending'}">${user.rol}</span></td>
                <td>${user.fecha_registro ? new Date(user.fecha_registro).toLocaleDateString() : 'N/A'}</td>
                <td><span class="status-badge ${user.activo ? 'status-active' : 'status-inactive'}">${user.activo ? 'Activo' : 'Inactivo'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-edit" onclick="editUser(${user.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteUser(${user.id}, '${user.nombre}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function renderEmptyUsersTable() {
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-people"></i>
                    <h3>No hay usuarios registrados</h3>
                    <p>Agrega el primer usuario</p>
                </td>
            </tr>
        `;
    }
    
    function showAddUserModal() {
        document.getElementById('add-user-alert').style.display = 'none';
        document.getElementById('add-user-form').reset();
        openModal('modal-add-user');
    }
    
    async function addNewUser() {
        const name = document.getElementById('new-user-name').value.trim();
        const email = document.getElementById('new-user-email').value.trim().toLowerCase();
        const password = document.getElementById('new-user-password').value;
        const phone = document.getElementById('new-user-phone').value.trim();
        const role = document.getElementById('new-user-role').value;
        
        if (!name || !email || !password) {
            showModalAlert('add-user-alert', 'Nombre, email y contraseña son obligatorios', 'error');
            return;
        }
        
        if (password.length < 6) {
            showModalAlert('add-user-alert', 'La contraseña debe tener al menos 6 caracteres', 'error');
            return;
        }
        
        const userData = {
            nombre: name,
            email: email,
            password: password,
            telefono: phone || '',
            rol: role
        };
        
        showModalAlert('add-user-alert', 'Creando usuario...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('add-user-alert', 'Usuario creado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-add-user');
                    loadUsers();
                    loadDashboardData();
                }, 1500);
            } else {
                showModalAlert('add-user-alert', data.error || 'Error al crear usuario', 'error');
            }
        } catch (error) {
            console.error('Error creando usuario:', error);
            showModalAlert('add-user-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    async function editUser(userId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const user = await response.json();
                
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.nombre || '';
                document.getElementById('edit-user-email').value = user.email || '';
                document.getElementById('edit-user-phone').value = user.telefono || '';
                document.getElementById('edit-user-role').value = user.rol || 'user';
                document.getElementById('edit-user-status').value = user.activo ? 'active' : 'inactive';
                
                document.getElementById('edit-user-alert').style.display = 'none';
                openModal('modal-edit-user');
            }
        } catch (error) {
            console.error('Error cargando usuario:', error);
            showAlert('Error cargando datos del usuario', 'error');
        }
    }
    
    async function saveUserEdit() {
        const id = document.getElementById('edit-user-id').value;
        const name = document.getElementById('edit-user-name').value.trim();
        const email = document.getElementById('edit-user-email').value.trim();
        const phone = document.getElementById('edit-user-phone').value.trim();
        const role = document.getElementById('edit-user-role').value;
        const status = document.getElementById('edit-user-status').value;
        
        if (!name || !email) {
            showModalAlert('edit-user-alert', 'Nombre y email son obligatorios', 'error');
            return;
        }
        
        const userData = {
            nombre: name,
            email: email,
            telefono: phone,
            rol: role,
            activo: status === 'active'
        };
        
        showModalAlert('edit-user-alert', 'Actualizando usuario...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('edit-user-alert', 'Usuario actualizado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-edit-user');
                    loadUsers();
                }, 1500);
            } else {
                showModalAlert('edit-user-alert', data.error || 'Error al actualizar usuario', 'error');
            }
        } catch (error) {
            console.error('Error actualizando usuario:', error);
            showModalAlert('edit-user-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    function deleteUser(userId, userName) {
        confirmAction(`¿Eliminar al usuario "${userName}"?`, async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Usuario eliminado correctamente', 'success');
                    loadUsers();
                    loadDashboardData();
                } else {
                    showAlert(data.error || 'Error al eliminar usuario', 'error');
                }
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showAlert('Error de conexión con el servidor', 'error');
            }
        });
    }
    
    // ========== TOURS - CRUD COMPLETO ==========
    async function loadTours() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/tours`);
            
            if (response.ok) {
                toursData = await response.json();
                renderToursTable(toursData);
            } else {
                throw new Error('Error cargando tours');
            }
        } catch (error) {
            console.error('Error cargando tours:', error);
            showAlert('Error cargando tours', 'error');
            renderEmptyToursTable();
        }
    }
    
    function renderToursTable(tours) {
        const tbody = document.getElementById('tours-table-body');
        if (!tbody) return;
        
        if (!tours || tours.length === 0) {
            renderEmptyToursTable();
            return;
        }
        
        tbody.innerHTML = '';
        tours.forEach(tour => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${tour.id}</td>
                <td><strong>${tour.nombre}</strong></td>
                <td>${tour.descripcion?.substring(0, 50)}${tour.descripcion?.length > 50 ? '...' : ''}</td>
                <td>$${tour.precio?.toFixed(2)}</td>
                <td>${tour.capacidad}</td>
                <td><span class="status-badge ${tour.disponible ? 'status-active' : 'status-inactive'}">${tour.disponible ? 'Disponible' : 'No disponible'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-edit" onclick="editTour(${tour.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteTour(${tour.id}, '${tour.nombre}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function renderEmptyToursTable() {
        const tbody = document.getElementById('tours-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-signpost"></i>
                    <h3>No hay tours disponibles</h3>
                    <p>Agrega el primer tour</p>
                </td>
            </tr>
        `;
    }
    
    function showAddTourModal() {
        document.getElementById('add-tour-alert').style.display = 'none';
        document.getElementById('add-tour-form').reset();
        document.getElementById('tour-image-preview').style.display = 'none';
        document.getElementById('tour-image-data').value = '';
        document.getElementById('new-tour-image-url').value = '';
        document.getElementById('tour-upload-progress').style.display = 'none';
        
        // Resetear opciones de imagen
        currentImageOption = 'upload';
        const uploadSection = document.getElementById('image-upload-section');
        const urlSection = document.getElementById('image-url-section');
        const buttons = document.querySelectorAll('#modal-add-tour .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        buttons[0].classList.add('active');
        uploadSection.style.display = 'block';
        urlSection.style.display = 'none';
        
        openModal('modal-add-tour');
    }
    
    async function addNewTour() {
        const name = document.getElementById('new-tour-name').value.trim();
        const desc = document.getElementById('new-tour-desc').value.trim();
        const price = parseFloat(document.getElementById('new-tour-price').value);
        const capacity = parseInt(document.getElementById('new-tour-capacity').value);
        const duration = document.getElementById('new-tour-duration').value.trim();
        const available = document.getElementById('new-tour-available').value === 'true';
        
        if (!name || !desc || !price || !capacity || !duration) {
            showModalAlert('add-tour-alert', 'Todos los campos son obligatorios', 'error');
            return;
        }
        
        if (price <= 0) {
            showModalAlert('add-tour-alert', 'El precio debe ser mayor a 0', 'error');
            return;
        }
        
        if (capacity <= 0) {
            showModalAlert('add-tour-alert', 'La capacidad debe ser mayor a 0', 'error');
            return;
        }
        
        // Manejar la imagen
        let imagen_url = null;
        if (currentImageOption === 'upload') {
            const imageData = document.getElementById('tour-image-data').value;
            if (imageData) {
                // Para producción, deberías subir la imagen al servidor
                imagen_url = imageData;
            }
        } else {
            const imageUrl = document.getElementById('new-tour-image-url').value.trim();
            if (imageUrl) {
                imagen_url = imageUrl;
            }
        }
        
        const tourData = {
            nombre: name,
            descripcion: desc,
            precio: price,
            capacidad: capacity,
            duracion: duration,
            disponible: available,
            imagen_url: imagen_url
        };
        
        showModalAlert('add-tour-alert', 'Creando tour...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/tours`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(tourData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('add-tour-alert', 'Tour creado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-add-tour');
                    loadTours();
                    loadDashboardData();
                }, 1500);
            } else {
                showModalAlert('add-tour-alert', data.error || 'Error al crear tour', 'error');
            }
        } catch (error) {
            console.error('Error creando tour:', error);
            showModalAlert('add-tour-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    async function editTour(tourId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/tours/${tourId}`);
            
            if (response.ok) {
                const tour = await response.json();
                
                document.getElementById('edit-tour-id').value = tour.id;
                document.getElementById('edit-tour-name').value = tour.nombre;
                document.getElementById('edit-tour-desc').value = tour.descripcion;
                document.getElementById('edit-tour-price').value = tour.precio;
                document.getElementById('edit-tour-capacity').value = tour.capacidad;
                document.getElementById('edit-tour-duration').value = tour.duracion || '';
                document.getElementById('edit-tour-available').value = tour.disponible ? 'true' : 'false';
                document.getElementById('edit-tour-image-url').value = tour.imagen_url || '';
                
                if (tour.imagen_url) {
                    document.getElementById('edit-tour-image-preview').src = tour.imagen_url;
                    document.getElementById('edit-tour-image-preview').style.display = 'block';
                    
                    // Si es una URL, mostrar esa opción
                    if (tour.imagen_url.startsWith('http')) {
                        toggleEditImageOption('url');
                        document.getElementById('edit-tour-image-url').value = tour.imagen_url;
                    } else {
                        toggleEditImageOption('upload');
                        document.getElementById('edit-tour-image-data').value = tour.imagen_url;
                    }
                } else {
                    document.getElementById('edit-tour-image-preview').style.display = 'none';
                }
                
                document.getElementById('edit-tour-alert').style.display = 'none';
                openModal('modal-edit-tour');
            }
        } catch (error) {
            console.error('Error cargando tour:', error);
            showAlert('Error cargando datos del tour', 'error');
        }
    }
    
    async function saveTourEdit() {
        const id = document.getElementById('edit-tour-id').value;
        const name = document.getElementById('edit-tour-name').value.trim();
        const desc = document.getElementById('edit-tour-desc').value.trim();
        const price = parseFloat(document.getElementById('edit-tour-price').value);
        const capacity = parseInt(document.getElementById('edit-tour-capacity').value);
        const duration = document.getElementById('edit-tour-duration').value.trim();
        const available = document.getElementById('edit-tour-available').value === 'true';
        
        if (!name || !desc || !price || !capacity || !duration) {
            showModalAlert('edit-tour-alert', 'Todos los campos son obligatorios', 'error');
            return;
        }
        
        // Manejar la imagen
        let imagen_url = null;
        if (currentEditImageOption === 'upload') {
            const imageData = document.getElementById('edit-tour-image-data').value;
            if (imageData) {
                imagen_url = imageData;
            }
        } else {
            const imageUrl = document.getElementById('edit-tour-image-url').value.trim();
            if (imageUrl) {
                imagen_url = imageUrl;
            }
        }
        
        const tourData = {
            nombre: name,
            descripcion: desc,
            precio: price,
            capacidad: capacity,
            duracion: duration,
            disponible: available,
            imagen_url: imagen_url
        };
        
        showModalAlert('edit-tour-alert', 'Actualizando tour...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/tours/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(tourData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('edit-tour-alert', 'Tour actualizado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-edit-tour');
                    loadTours();
                }, 1500);
            } else {
                showModalAlert('edit-tour-alert', data.error || 'Error al actualizar tour', 'error');
            }
        } catch (error) {
            console.error('Error actualizando tour:', error);
            showModalAlert('edit-tour-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    function deleteTour(tourId, tourName) {
        confirmAction(`¿Eliminar el tour "${tourName}"?`, async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/tours/${tourId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Tour eliminado correctamente', 'success');
                    loadTours();
                    loadDashboardData();
                } else {
                    showAlert(data.error || 'Error al eliminar tour', 'error');
                }
            } catch (error) {
                console.error('Error eliminando tour:', error);
                showAlert('Error de conexión con el servidor', 'error');
            }
        });
    }
    
    // ========== BLOG - CRUD COMPLETO ==========
    async function loadBlogPosts() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/blog`);
            
            if (response.ok) {
                allBlogPosts = await response.json();
                filterBlogPosts();
            } else {
                throw new Error('Error cargando posts del blog');
            }
        } catch (error) {
            console.error('Error cargando blog:', error);
            showAlert('Error cargando artículos del blog', 'error');
            renderEmptyBlogTable();
        }
    }
    
    function filterBlogPosts() {
        const categoryFilter = document.getElementById('blog-filter-category').value;
        const statusFilter = document.getElementById('blog-filter-status').value;
        
        let filteredPosts = allBlogPosts;
        
        if (categoryFilter !== 'all') {
            filteredPosts = filteredPosts.filter(post => post.categoria === categoryFilter);
        }
        
        if (statusFilter !== 'all') {
            if (statusFilter === 'published') {
                filteredPosts = filteredPosts.filter(post => post.publicado);
            } else if (statusFilter === 'draft') {
                filteredPosts = filteredPosts.filter(post => !post.publicado);
            }
        }
        
        blogPostsData = filteredPosts;
        renderBlogTable(filteredPosts);
    }
    
    function renderBlogTable(posts) {
        const tbody = document.getElementById('blog-table-body');
        if (!tbody) return;
        
        if (!posts || posts.length === 0) {
            renderEmptyBlogTable();
            return;
        }
        
        tbody.innerHTML = '';
        posts.forEach(post => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${post.titulo}</strong></td>
                <td><span class="status-badge status-pending">${post.categoria || 'General'}</span></td>
                <td>${post.autor || 'Anónimo'}</td>
                <td>${post.created_at ? new Date(post.created_at).toLocaleDateString() : 'N/A'}</td>
                <td>${post.vistas || 0}</td>
                <td><span class="status-badge ${post.publicado ? 'status-active' : 'status-pending'}">${post.publicado ? 'Publicado' : 'Borrador'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-view" onclick="previewBlogPost(${post.id})"><i class="bi bi-eye"></i></button>
                        <button class="btn-icon btn-edit" onclick="editBlogPost(${post.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteBlogPost(${post.id}, '${post.titulo}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function renderEmptyBlogTable() {
        const tbody = document.getElementById('blog-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-newspaper"></i>
                    <h3>No hay artículos de blog</h3>
                    <p>Crea el primer artículo</p>
                </td>
            </tr>
        `;
    }
    
    function showAddBlogPostModal() {
        document.getElementById('add-blog-alert').style.display = 'none';
        document.getElementById('blog-title').value = '';
        document.getElementById('blog-category').value = 'noticias';
        document.getElementById('blog-author').value = currentUser?.nombre || 'Administrador';
        document.getElementById('blog-excerpt').value = '';
        document.getElementById('blog-image-url').value = '';
        document.getElementById('blog-content-textarea').value = '';
        document.getElementById('blog-published').checked = true;
        document.getElementById('blog-image-preview').style.display = 'none';
        document.getElementById('blog-image-data').value = '';
        document.getElementById('blog-upload-progress').style.display = 'none';
        
        // Resetear opciones de imagen
        currentBlogImageOption = 'upload';
        const uploadSection = document.getElementById('blog-image-upload-section');
        const urlSection = document.getElementById('blog-image-url-section');
        const buttons = document.querySelectorAll('#modal-add-blog .image-option-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        buttons[0].classList.add('active');
        uploadSection.style.display = 'block';
        urlSection.style.display = 'none';
        
        openModal('modal-add-blog');
    }
    
    async function saveBlogPost() {
        const title = document.getElementById('blog-title').value.trim();
        const category = document.getElementById('blog-category').value;
        const author = document.getElementById('blog-author').value.trim();
        const excerpt = document.getElementById('blog-excerpt').value.trim();
        const content = document.getElementById('blog-content-textarea').value.trim();
        const published = document.getElementById('blog-published').checked;
        
        if (!title) {
            showModalAlert('add-blog-alert', 'El título es obligatorio', 'error');
            return;
        }
        
        if (!author) {
            showModalAlert('add-blog-alert', 'El autor es obligatorio', 'error');
            return;
        }
        
        if (!content) {
            showModalAlert('add-blog-alert', 'El contenido es obligatorio', 'error');
            return;
        }
        
        // Manejar la imagen
        let imagen_url = null;
        if (currentBlogImageOption === 'upload') {
            const imageData = document.getElementById('blog-image-data').value;
            if (imageData) {
                imagen_url = imageData;
            }
        } else {
            const imageUrl = document.getElementById('blog-image-url').value.trim();
            if (imageUrl) {
                imagen_url = imageUrl;
            }
        }
        
        const blogData = {
            titulo: title,
            contenido: content,
            excerpt: excerpt,
            categoria: category,
            autor: author,
            imagen_url: imagen_url,
            publicado: published
        };
        
        showModalAlert('add-blog-alert', 'Publicando artículo...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/blog`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(blogData)
            });
            
            const data = await response.json();
            
            if (data.success && data.blog) {
                showModalAlert('add-blog-alert', 'Artículo publicado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-add-blog');
                    loadBlogPosts();
                    loadDashboardData();
                }, 1500);
            } else {
                showModalAlert('add-blog-alert', data.error || 'Error al publicar artículo', 'error');
            }
        } catch (error) {
            console.error('Error publicando artículo:', error);
            showModalAlert('add-blog-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    async function editBlogPost(postId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/blog/${postId}`);
            
            if (response.ok) {
                const post = await response.json();
                
                document.getElementById('edit-blog-id').value = post.id;
                document.getElementById('edit-blog-title').value = post.titulo;
                document.getElementById('edit-blog-category').value = post.categoria || 'noticias';
                document.getElementById('edit-blog-author').value = post.autor || '';
                document.getElementById('edit-blog-excerpt').value = post.excerpt || '';
                document.getElementById('edit-blog-content-textarea').value = post.contenido || '';
                document.getElementById('edit-blog-published').checked = post.publicado || false;
                document.getElementById('edit-blog-image-url').value = post.imagen_url || '';
                
                if (post.imagen_url) {
                    document.getElementById('edit-blog-image-preview').src = post.imagen_url;
                    document.getElementById('edit-blog-image-preview').style.display = 'block';
                    
                    // Si es una URL, mostrar esa opción
                    if (post.imagen_url.startsWith('http')) {
                        toggleEditBlogImageOption('url');
                        document.getElementById('edit-blog-image-url').value = post.imagen_url;
                    } else {
                        toggleEditBlogImageOption('upload');
                        document.getElementById('edit-blog-image-data').value = post.imagen_url;
                    }
                } else {
                    document.getElementById('edit-blog-image-preview').style.display = 'none';
                }
                
                document.getElementById('edit-blog-alert').style.display = 'none';
                openModal('modal-edit-blog');
            }
        } catch (error) {
            console.error('Error cargando artículo:', error);
            showAlert('Error cargando datos del artículo', 'error');
        }
    }
    
    async function saveBlogEdit() {
        const id = document.getElementById('edit-blog-id').value;
        const title = document.getElementById('edit-blog-title').value.trim();
        const category = document.getElementById('edit-blog-category').value;
        const author = document.getElementById('edit-blog-author').value.trim();
        const excerpt = document.getElementById('edit-blog-excerpt').value.trim();
        const content = document.getElementById('edit-blog-content-textarea').value.trim();
        const published = document.getElementById('edit-blog-published').checked;
        
        if (!title) {
            showModalAlert('edit-blog-alert', 'El título es obligatorio', 'error');
            return;
        }
        
        if (!author) {
            showModalAlert('edit-blog-alert', 'El autor es obligatorio', 'error');
            return;
        }
        
        if (!content) {
            showModalAlert('edit-blog-alert', 'El contenido es obligatorio', 'error');
            return;
        }
        
        // Manejar la imagen
        let imagen_url = null;
        if (currentEditBlogImageOption === 'upload') {
            const imageData = document.getElementById('edit-blog-image-data').value;
            if (imageData) {
                imagen_url = imageData;
            }
        } else {
            const imageUrl = document.getElementById('edit-blog-image-url').value.trim();
            if (imageUrl) {
                imagen_url = imageUrl;
            }
        }
        
        const blogData = {
            titulo: title,
            contenido: content,
            excerpt: excerpt,
            categoria: category,
            autor: author,
            imagen_url: imagen_url,
            publicado: published
        };
        
        showModalAlert('edit-blog-alert', 'Actualizando artículo...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/blog/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(blogData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('edit-blog-alert', 'Artículo actualizado correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-edit-blog');
                    loadBlogPosts();
                }, 1500);
            } else {
                showModalAlert('edit-blog-alert', data.error || 'Error al actualizar artículo', 'error');
            }
        } catch (error) {
            console.error('Error actualizando artículo:', error);
            showModalAlert('edit-blog-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    function previewBlogPost(postId) {
        const post = blogPostsData.find(p => p.id === postId);
        if (!post) {
            showAlert('Artículo no encontrado', 'error');
            return;
        }
        
        const previewContent = document.getElementById('blog-preview-content');
        previewContent.innerHTML = `
            <div class="blog-preview">
                <h1>${post.titulo}</h1>
                <div class="meta">
                    <strong>Categoría:</strong> ${post.categoria || 'General'} |
                    <strong>Autor:</strong> ${post.autor || 'Anónimo'} |
                    <strong>Fecha:</strong> ${post.created_at ? new Date(post.created_at).toLocaleDateString() : 'N/A'} |
                    <strong>Vistas:</strong> ${post.vistas || 0} |
                    <strong>Estado:</strong> ${post.publicado ? 'Publicado' : 'Borrador'}
                </div>
                ${post.imagen_url ? `<img src="${post.imagen_url}" alt="${post.titulo}" style="max-width: 100%; border-radius: 8px; margin-bottom: 20px;">` : ''}
                ${post.excerpt ? `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-style: italic;">${post.excerpt}</div>` : ''}
                <div style="line-height: 1.6; font-size: 16px;">
                    ${post.contenido ? post.contenido.replace(/\n/g, '<br>') : '<p>Contenido no disponible</p>'}
                </div>
            </div>
        `;
        
        openModal('modal-preview-blog');
    }
    
    function deleteBlogPost(postId, postTitle) {
        confirmAction(`¿Eliminar el artículo "${postTitle}"?`, async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/blog/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Artículo eliminado correctamente', 'success');
                    loadBlogPosts();
                    loadDashboardData();
                } else {
                    showAlert(data.error || 'Error al eliminar artículo', 'error');
                }
            } catch (error) {
                console.error('Error eliminando artículo:', error);
                showAlert('Error de conexión con el servidor', 'error');
            }
        });
    }
    
    // ========== RESERVAS ==========
    async function loadBookings() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/bookings`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                allBookings = await response.json();
                renderBookingsTable(allBookings);
            } else {
                throw new Error('Error cargando reservas');
            }
        } catch (error) {
            console.error('Error cargando reservas:', error);
            showAlert('Error cargando reservas', 'error');
            renderEmptyBookingsTable();
        }
    }
    
    function renderBookingsTable(bookings) {
        const tbody = document.getElementById('bookings-table-body');
        if (!tbody) return;
        
        if (!bookings || bookings.length === 0) {
            renderEmptyBookingsTable();
            return;
        }
        
        tbody.innerHTML = '';
        bookings.forEach(booking => {
            const statusClass = booking.estado === 'confirmed' ? 'status-confirmed' : 
                              booking.estado === 'cancelled' ? 'status-cancelled' : 'status-pending';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${booking.id}</td>
                <td>${booking.user_nombre || `Usuario ${booking.user_id}`}</td>
                <td>${booking.tour_nombre || `Tour ${booking.tour_id}`}</td>
                <td>${booking.fecha ? new Date(booking.fecha).toLocaleDateString() : 'N/A'}</td>
                <td>${booking.personas}</td>
                <td>$${booking.total?.toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${booking.estado || 'pending'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-edit" onclick="editBooking(${booking.id})"><i class="bi bi-pencil"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function renderEmptyBookingsTable() {
        const tbody = document.getElementById('bookings-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <i class="bi bi-calendar-check"></i>
                    <h3>No hay reservas</h3>
                    <p>No se han realizado reservas aún</p>
                </td>
            </tr>
        `;
    }
    
    async function editBooking(bookingId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/bookings/${bookingId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const booking = await response.json();
                
                document.getElementById('booking-id').value = booking.id;
                document.getElementById('booking-user').value = booking.user_nombre || `Usuario ${booking.user_id}`;
                document.getElementById('booking-tour').value = booking.tour_nombre || `Tour ${booking.tour_id}`;
                document.getElementById('booking-date').value = booking.fecha ? booking.fecha.split('T')[0] : '';
                document.getElementById('booking-people').value = booking.personas || 1;
                document.getElementById('booking-total').value = booking.total || 0;
                document.getElementById('booking-status').value = booking.estado || 'pending';
                document.getElementById('booking-notes').value = booking.notas || '';
                
                document.getElementById('booking-alert').style.display = 'none';
                openModal('modal-booking');
            }
        } catch (error) {
            console.error('Error cargando reserva:', error);
            showAlert('Error cargando datos de la reserva', 'error');
        }
    }
    
    async function saveBooking() {
        const id = document.getElementById('booking-id').value;
        const bookingData = {
            fecha: document.getElementById('booking-date').value,
            personas: parseInt(document.getElementById('booking-people').value),
            total: parseFloat(document.getElementById('booking-total').value),
            estado: document.getElementById('booking-status').value,
            notas: document.getElementById('booking-notes').value
        };
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/bookings/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(bookingData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('booking-alert', 'Reserva actualizada correctamente', 'success');
                setTimeout(() => {
                    closeModal('modal-booking');
                    loadBookings();
                }, 1500);
            } else {
                showModalAlert('booking-alert', data.error || 'Error al actualizar la reserva', 'error');
            }
        } catch (error) {
            console.error('Error guardando reserva:', error);
            showModalAlert('booking-alert', 'Error de conexión', 'error');
        }
    }
    
    function exportBookingsToCSV() {
        if (allBookings.length === 0) {
            showAlert('No hay datos para exportar', 'error');
            return;
        }
        
        // Crear CSV
        let csv = 'ID,Usuario,Tour,Fecha,Personas,Total,Estado,Notas\n';
        allBookings.forEach(booking => {
            const fecha = booking.fecha ? new Date(booking.fecha).toLocaleDateString() : '';
            const usuario = (booking.user_nombre || `Usuario ${booking.user_id}`).replace(/"/g, '""');
            const tour = (booking.tour_nombre || `Tour ${booking.tour_id}`).replace(/"/g, '""');
            const notas = (booking.notas || '').replace(/"/g, '""');
            
            csv += `"${booking.id}","${usuario}","${tour}","${fecha}","${booking.personas}","${booking.total || 0}","${booking.estado || ''}","${notas}"\n`;
        });
        
        // Descargar
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reservas_cano_salao_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('CSV exportado correctamente', 'success');
    }
    
    // ========== REPORTES ==========
    function updateReportForm() {
        const reportType = document.getElementById('report-type').value;
        const dateInputs = document.querySelectorAll('#report-start-date, #report-end-date');
        
        // Mostrar/ocultar controles según el tipo de reporte
        if (reportType === 'dashboard') {
            dateInputs.forEach(input => input.style.display = 'none');
        } else {
            dateInputs.forEach(input => input.style.display = 'block');
        }
    }
    
    async function generateReport() {
        const type = document.getElementById('report-type').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        
        try {
            let reportData = null;
            
            switch(type) {
                case 'dashboard':
                    reportData = await generateDashboardReportData();
                    break;
                case 'bookings':
                    reportData = await generateBookingsReportData(startDate, endDate);
                    break;
                case 'financial':
                    reportData = await generateFinancialReportData(startDate, endDate);
                    break;
                case 'users':
                    reportData = await generateUsersReportData();
                    break;
                case 'tours':
                    reportData = await generateToursReportData();
                    break;
            }
            
            if (reportData) {
                currentReportData = reportData;
                displayReport(reportData, type);
                showAlert('Reporte generado correctamente', 'success');
            }
            
        } catch (error) {
            console.error('Error generando reporte:', error);
            showAlert('Error generando reporte: ' + error.message, 'error');
        }
    }
    
    async function generateDashboardReportData() {
        try {
            // Obtener datos del dashboard
            const [usersRes, toursRes, bookingsRes, blogRes] = await Promise.allSettled([
                fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch(`${API_BASE_URL}/api/tours`),
                fetch(`${API_BASE_URL}/api/admin/bookings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch(`${API_BASE_URL}/api/blog`)
            ]);
            
            const stats = {
                total_users: 0,
                active_users: 0,
                total_blog_posts: 0,
                total_tours: 0,
                active_tours: 0,
                total_bookings: 0,
                confirmed_bookings: 0,
                pending_bookings: 0,
                cancelled_bookings: 0,
                total_revenue: 0
            };
            
            // Procesar usuarios
            if (usersRes.status === 'fulfilled' && usersRes.value.ok) {
                const users = await usersRes.value.json();
                stats.total_users = users.length;
                stats.active_users = users.filter(u => u.activo).length;
            }
            
            // Procesar tours
            if (toursRes.status === 'fulfilled' && toursRes.value.ok) {
                const tours = await toursRes.value.json();
                stats.total_tours = tours.length;
                stats.active_tours = tours.filter(t => t.disponible).length;
            }
            
            // Procesar reservas
            if (bookingsRes.status === 'fulfilled' && bookingsRes.value.ok) {
                const bookings = await bookingsRes.value.json();
                stats.total_bookings = bookings.length;
                stats.confirmed_bookings = bookings.filter(b => b.estado === 'confirmed').length;
                stats.pending_bookings = bookings.filter(b => b.estado === 'pending').length;
                stats.cancelled_bookings = bookings.filter(b => b.estado === 'cancelled').length;
                stats.total_revenue = bookings
                    .filter(b => b.estado === 'confirmed')
                    .reduce((sum, b) => sum + (b.total || 0), 0);
            }
            
            // Procesar blog
            if (blogRes.status === 'fulfilled' && blogRes.value.ok) {
                const blogPosts = await blogRes.value.json();
                stats.total_blog_posts = blogPosts.length;
            }
            
            return {
                title: 'Reporte General del Sistema',
                generated_at: new Date().toISOString(),
                stats: stats,
                type: 'dashboard'
            };
            
        } catch (error) {
            console.error('Error generando reporte dashboard:', error);
            throw error;
        }
    }
    
    async function generateBookingsReportData(startDate, endDate) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/bookings`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Error cargando reservas');
            
            let bookings = await response.json();
            
            // Filtrar por fecha si se proporciona
            if (startDate && endDate) {
                bookings = bookings.filter(b => {
                    const bookingDate = b.fecha ? new Date(b.fecha).toISOString().split('T')[0] : '';
                    return bookingDate >= startDate && bookingDate <= endDate;
                });
            }
            
            // Calcular estadísticas
            const stats = {
                total: bookings.length,
                by_status: {},
                by_month: {},
                total_revenue: 0,
                average_booking_value: 0
            };
            
            bookings.forEach(booking => {
                // Por estado
                const status = booking.estado || 'unknown';
                stats.by_status[status] = (stats.by_status[status] || 0) + 1;
                
                // Por mes
                if (booking.fecha) {
                    const date = new Date(booking.fecha);
                    const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                    stats.by_month[monthYear] = (stats.by_month[monthYear] || 0) + 1;
                }
                
                // Revenue
                if (booking.estado === 'confirmed' && booking.total) {
                    stats.total_revenue += booking.total;
                }
            });
            
            // Calcular promedio
            const confirmedBookings = bookings.filter(b => b.estado === 'confirmed').length;
            stats.average_booking_value = confirmedBookings > 0 ? stats.total_revenue / confirmedBookings : 0;
            
            return {
                title: 'Reporte de Reservas',
                period: `${startDate || 'Inicio'} - ${endDate || 'Actual'}`,
                generated_at: new Date().toISOString(),
                stats: stats,
                bookings: bookings.slice(0, 50), // Limitar para preview
                type: 'bookings'
            };
            
        } catch (error) {
            console.error('Error generando reporte de reservas:', error);
            throw error;
        }
    }
    
    async function generateFinancialReportData(startDate, endDate) {
        try {
            const [bookingsRes, toursRes] = await Promise.allSettled([
                fetch(`${API_BASE_URL}/api/admin/bookings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch(`${API_BASE_URL}/api/tours`)
            ]);
            
            let bookings = [];
            let tours = [];
            
            if (bookingsRes.status === 'fulfilled' && bookingsRes.value.ok) {
                bookings = await bookingsRes.value.json();
            }
            
            if (toursRes.status === 'fulfilled' && toursRes.value.ok) {
                tours = await toursRes.value.json();
            }
            
            // Filtrar reservas por fecha y estado confirmed
            if (startDate && endDate) {
                bookings = bookings.filter(b => {
                    const bookingDate = b.fecha ? new Date(b.fecha).toISOString().split('T')[0] : '';
                    return bookingDate >= startDate && bookingDate <= endDate && b.estado === 'confirmed';
                });
            } else {
                bookings = bookings.filter(b => b.estado === 'confirmed');
            }
            
            // Calcular revenue por tour
            const revenueByTour = {};
            const bookingsByTour = {};
            
            bookings.forEach(booking => {
                const tourId = booking.tour_id;
                const tourName = tours.find(t => t.id === tourId)?.nombre || `Tour ${tourId}`;
                
                if (!revenueByTour[tourId]) {
                    revenueByTour[tourId] = {
                        name: tourName,
                        revenue: 0,
                        bookings: 0
                    };
                }
                
                revenueByTour[tourId].revenue += booking.total || 0;
                revenueByTour[tourId].bookings += 1;
                bookingsByTour[tourId] = (bookingsByTour[tourId] || 0) + 1;
            });
            
            // Calcular revenue mensual
            const monthlyRevenue = {};
            bookings.forEach(booking => {
                if (booking.fecha) {
                    const date = new Date(booking.fecha);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyRevenue[monthYear] = (monthlyRevenue[monthYear] || 0) + (booking.total || 0);
                }
            });
            
            const totalRevenue = bookings.reduce((sum, b) => sum + (b.total || 0), 0);
            
            return {
                title: 'Reporte Financiero',
                period: `${startDate || 'Inicio'} - ${endDate || 'Actual'}`,
                generated_at: new Date().toISOString(),
                total_revenue: totalRevenue,
                total_bookings: bookings.length,
                average_revenue_per_booking: bookings.length > 0 ? totalRevenue / bookings.length : 0,
                revenue_by_tour: Object.values(revenueByTour),
                monthly_revenue: monthlyRevenue,
                type: 'financial'
            };
            
        } catch (error) {
            console.error('Error generando reporte financiero:', error);
            throw error;
        }
    }
    
    async function generateUsersReportData() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Error cargando usuarios');
            
            const users = await response.json();
            
            // Estadísticas de usuarios
            const stats = {
                total: users.length,
                active: users.filter(u => u.activo).length,
                inactive: users.filter(u => !u.activo).length,
                by_role: {},
                by_registration_month: {}
            };
            
            users.forEach(user => {
                // Por rol
                const role = user.rol || 'unknown';
                stats.by_role[role] = (stats.by_role[role] || 0) + 1;
                
                // Por mes de registro
                if (user.fecha_registro) {
                    const date = new Date(user.fecha_registro);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    stats.by_registration_month[monthYear] = (stats.by_registration_month[monthYear] || 0) + 1;
                }
            });
            
            return {
                title: 'Reporte de Usuarios',
                generated_at: new Date().toISOString(),
                stats: stats,
                users: users.slice(0, 50), // Limitar para preview
                type: 'users'
            };
            
        } catch (error) {
            console.error('Error generando reporte de usuarios:', error);
            throw error;
        }
    }
    
    async function generateToursReportData() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/tours`);
            
            if (!response.ok) throw new Error('Error cargando tours');
            
            const tours = await response.json();
            
            // Estadísticas de tours
            const stats = {
                total: tours.length,
                available: tours.filter(t => t.disponible).length,
                unavailable: tours.filter(t => !t.disponible).length,
                by_price_range: {
                    low: tours.filter(t => t.precio < 50).length,
                    medium: tours.filter(t => t.precio >= 50 && t.precio < 100).length,
                    high: tours.filter(t => t.precio >= 100).length
                },
                average_price: tours.reduce((sum, t) => sum + (t.precio || 0), 0) / tours.length || 0,
                total_capacity: tours.reduce((sum, t) => sum + (t.capacidad || 0), 0)
            };
            
            return {
                title: 'Reporte de Tours',
                generated_at: new Date().toISOString(),
                stats: stats,
                tours: tours.slice(0, 50), // Limitar para preview
                type: 'tours'
            };
            
        } catch (error) {
            console.error('Error generando reporte de tours:', error);
            throw error;
        }
    }
    
    function displayReport(reportData, type) {
        const reportContent = document.getElementById('report-content');
        
        let html = `
            <div class="report-header">
                <h2>${reportData.title}</h2>
                <p>Generado: ${new Date(reportData.generated_at).toLocaleString()}</p>
                ${reportData.period ? `<p>Período: ${reportData.period}</p>` : ''}
            </div>
        `;
        
        switch(type) {
            case 'dashboard':
                html += displayDashboardReport(reportData);
                break;
            case 'bookings':
                html += displayBookingsReport(reportData);
                break;
            case 'financial':
                html += displayFinancialReport(reportData);
                break;
            case 'users':
                html += displayUsersReport(reportData);
                break;
            case 'tours':
                html += displayToursReport(reportData);
                break;
        }
        
        reportContent.innerHTML = html;
        
        // Crear gráfico si es necesario
        createReportChart(reportData, type);
    }
    
    function displayDashboardReport(reportData) {
        const stats = reportData.stats;
        return `
            <div class="report-data">
                <div class="report-section">
                    <h3><i class="bi bi-people"></i> Usuarios</h3>
                    <p><strong>Total:</strong> ${stats.total_users}</p>
                    <p><strong>Activos:</strong> ${stats.active_users}</p>
                    <p><strong>Inactivos:</strong> ${stats.total_users - stats.active_users}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-signpost"></i> Tours</h3>
                    <p><strong>Total:</strong> ${stats.total_tours}</p>
                    <p><strong>Disponibles:</strong> ${stats.active_tours}</p>
                    <p><strong>No disponibles:</strong> ${stats.total_tours - stats.active_tours}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-calendar-check"></i> Reservas</h3>
                    <p><strong>Total:</strong> ${stats.total_bookings}</p>
                    <p><strong>Confirmadas:</strong> ${stats.confirmed_bookings}</p>
                    <p><strong>Pendientes:</strong> ${stats.pending_bookings}</p>
                    <p><strong>Canceladas:</strong> ${stats.cancelled_bookings}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-cash-stack"></i> Financiero</h3>
                    <p><strong>Ingresos totales:</strong> $${stats.total_revenue.toFixed(2)}</p>
                    <p><strong>Artículos de blog:</strong> ${stats.total_blog_posts}</p>
                </div>
            </div>
        `;
    }
    
    function displayBookingsReport(reportData) {
        const stats = reportData.stats;
        let statusHtml = '';
        for (const [status, count] of Object.entries(stats.by_status)) {
            statusHtml += `<p><strong>${status}:</strong> ${count}</p>`;
        }
        
        let monthHtml = '';
        for (const [month, count] of Object.entries(stats.by_month)) {
            monthHtml += `<p><strong>${month}:</strong> ${count} reservas</p>`;
        }
        
        return `
            <div class="report-data">
                <div class="report-section">
                    <h3><i class="bi bi-bar-chart"></i> Resumen</h3>
                    <p><strong>Total reservas:</strong> ${stats.total}</p>
                    <p><strong>Ingresos totales:</strong> $${stats.total_revenue.toFixed(2)}</p>
                    <p><strong>Valor promedio:</strong> $${stats.average_booking_value.toFixed(2)}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-list-check"></i> Por Estado</h3>
                    ${statusHtml}
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-calendar-month"></i> Por Mes</h3>
                    ${monthHtml}
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3><i class="bi bi-table"></i> Reservas Recientes (${Math.min(reportData.bookings.length, 50)} de ${stats.total})</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Tour</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.bookings.map(booking => `
                                <tr>
                                    <td>${booking.id}</td>
                                    <td>${booking.user_nombre || `Usuario ${booking.user_id}`}</td>
                                    <td>${booking.tour_nombre || `Tour ${booking.tour_id}`}</td>
                                    <td>${booking.fecha ? new Date(booking.fecha).toLocaleDateString() : ''}</td>
                                    <td>$${booking.total?.toFixed(2) || '0.00'}</td>
                                    <td><span class="status-badge">${booking.estado || 'unknown'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function displayFinancialReport(reportData) {
        let tourRevenueHtml = '';
        reportData.revenue_by_tour.forEach(tour => {
            tourRevenueHtml += `
                <tr>
                    <td>${tour.name}</td>
                    <td>${tour.bookings}</td>
                    <td>$${tour.revenue.toFixed(2)}</td>
                    <td>$${(tour.revenue / tour.bookings).toFixed(2)}</td>
                </tr>
            `;
        });
        
        let monthlyRevenueHtml = '';
        for (const [month, revenue] of Object.entries(reportData.monthly_revenue)) {
            monthlyRevenueHtml += `<p><strong>${month}:</strong> $${revenue.toFixed(2)}</p>`;
        }
        
        return `
            <div class="report-data">
                <div class="report-section">
                    <h3><i class="bi bi-cash-stack"></i> Resumen Financiero</h3>
                    <p><strong>Ingresos totales:</strong> $${reportData.total_revenue.toFixed(2)}</p>
                    <p><strong>Total reservas:</strong> ${reportData.total_bookings}</p>
                    <p><strong>Ingreso promedio:</strong> $${reportData.average_revenue_per_booking.toFixed(2)}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-calendar-month"></i> Ingresos Mensuales</h3>
                    ${monthlyRevenueHtml}
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3><i class="bi bi-graph-up"></i> Ingresos por Tour</h3>
                <table class="admin-table" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Tour</th>
                            <th>Reservas</th>
                            <th>Ingresos Totales</th>
                            <th>Promedio por Reserva</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tourRevenueHtml}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 30px;">
                <canvas id="reportChart" height="150"></canvas>
            </div>
        `;
    }
    
    function displayUsersReport(reportData) {
        const stats = reportData.stats;
        
        let roleHtml = '';
        for (const [role, count] of Object.entries(stats.by_role)) {
            roleHtml += `<p><strong>${role}:</strong> ${count}</p>`;
        }
        
        let monthHtml = '';
        for (const [month, count] of Object.entries(stats.by_registration_month)) {
            monthHtml += `<p><strong>${month}:</strong> ${count} registros</p>`;
        }
        
        return `
            <div class="report-data">
                <div class="report-section">
                    <h3><i class="bi bi-people"></i> Resumen de Usuarios</h3>
                    <p><strong>Total:</strong> ${stats.total}</p>
                    <p><strong>Activos:</strong> ${stats.active}</p>
                    <p><strong>Inactivos:</strong> ${stats.inactive}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-person-badge"></i> Por Rol</h3>
                    ${roleHtml}
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-calendar-month"></i> Registros por Mes</h3>
                    ${monthHtml}
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3><i class="bi bi-table"></i> Usuarios (${Math.min(reportData.users.length, 50)} de ${stats.total})</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Registro</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.users.map(user => `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.nombre}</td>
                                    <td>${user.email}</td>
                                    <td><span class="status-badge">${user.rol}</span></td>
                                    <td>${user.fecha_registro ? new Date(user.fecha_registro).toLocaleDateString() : ''}</td>
                                    <td><span class="status-badge ${user.activo ? 'status-active' : 'status-inactive'}">${user.activo ? 'Activo' : 'Inactivo'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function displayToursReport(reportData) {
        const stats = reportData.stats;
        
        return `
            <div class="report-data">
                <div class="report-section">
                    <h3><i class="bi bi-signpost"></i> Resumen de Tours</h3>
                    <p><strong>Total:</strong> ${stats.total}</p>
                    <p><strong>Disponibles:</strong> ${stats.available}</p>
                    <p><strong>No disponibles:</strong> ${stats.unavailable}</p>
                    <p><strong>Capacidad total:</strong> ${stats.total_capacity} personas</p>
                    <p><strong>Precio promedio:</strong> $${stats.average_price.toFixed(2)}</p>
                </div>
                <div class="report-section">
                    <h3><i class="bi bi-tags"></i> Por Rango de Precio</h3>
                    <p><strong>Económico (&lt;$50):</strong> ${stats.by_price_range.low}</p>
                    <p><strong>Moderado ($50-$100):</strong> ${stats.by_price_range.medium}</p>
                    <p><strong>Premium (&gt;=$100):</strong> ${stats.by_price_range.high}</p>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3><i class="bi bi-table"></i> Tours (${Math.min(reportData.tours.length, 50)} de ${stats.total})</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Capacidad</th>
                                <th>Duración</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.tours.map(tour => `
                                <tr>
                                    <td>${tour.id}</td>
                                    <td>${tour.nombre}</td>
                                    <td>$${tour.precio?.toFixed(2)}</td>
                                    <td>${tour.capacidad}</td>
                                    <td>${tour.duracion || 'N/A'}</td>
                                    <td><span class="status-badge ${tour.disponible ? 'status-active' : 'status-inactive'}">${tour.disponible ? 'Disponible' : 'No disponible'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function createReportChart(reportData, type) {
        const canvas = document.getElementById('reportChart');
        if (!canvas || type !== 'financial') return;
        
        const ctx = canvas.getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (reportChart) {
            reportChart.destroy();
        }
        
        // Preparar datos para el gráfico
        const months = Object.keys(reportData.monthly_revenue).sort();
        const revenues = months.map(month => reportData.monthly_revenue[month]);
        
        reportChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months.map(month => {
                    const [year, monthNum] = month.split('-');
                    return `${monthNum}/${year}`;
                }),
                datasets: [{
                    label: 'Ingresos Mensuales',
                    data: revenues,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Ingresos: $${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function downloadReport() {
        if (!currentReportData) {
            showAlert('Primero genera un reporte', 'error');
            return;
        }
        
        // Crear contenido HTML para el reporte
        const printContent = document.getElementById('report-content').innerHTML;
        const title = currentReportData.title;
        const date = new Date().toLocaleString();
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${title} - Caño Salao</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2c3e50; padding-bottom: 15px; }
                    .header h1 { color: #2c3e50; margin: 0 0 10px 0; }
                    .header p { color: #666; margin: 5px 0; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
                    .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th { background: #2c3e50; color: white; padding: 10px; text-align: left; }
                    td { padding: 8px 10px; border-bottom: 1px solid #ddd; }
                    tr:hover { background: #f5f5f5; }
                    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
                    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center; }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>${title}</h1>
                    <p>Caño Salao - Sistema de Turismo</p>
                    <p>Generado: ${date}</p>
                    ${currentReportData.period ? `<p>Período: ${currentReportData.period}</p>` : ''}
                </div>
                ${printContent}
                <div class="footer">
                    <p>Reporte generado automáticamente por el sistema de administración de Caño Salao</p>
                    <p>© ${new Date().getFullYear()} Caño Salao - Todos los derechos reservados</p>
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                    };
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }
    
    function exportReportToExcel() {
        if (!currentReportData) {
            showAlert('Primero genera un reporte', 'error');
            return;
        }
        
        let csv = '';
        const type = currentReportData.type;
        const date = new Date().toISOString().split('T')[0];
        
        switch(type) {
            case 'bookings':
                csv = generateBookingsCSV();
                break;
            case 'financial':
                csv = generateFinancialCSV();
                break;
            case 'users':
                csv = generateUsersCSV();
                break;
            case 'tours':
                csv = generateToursCSV();
                break;
            case 'dashboard':
                csv = generateDashboardCSV();
                break;
        }
        
        if (csv) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_${type}_cano_salao_${date}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showAlert('Reporte exportado a Excel correctamente', 'success');
        }
    }
    
    function generateBookingsCSV() {
        let csv = 'ID,Usuario,Tour,Fecha,Personas,Total,Estado,Notas\n';
        currentReportData.bookings.forEach(booking => {
            const fecha = booking.fecha ? new Date(booking.fecha).toLocaleDateString() : '';
            const usuario = (booking.user_nombre || `Usuario ${booking.user_id}`).replace(/"/g, '""');
            const tour = (booking.tour_nombre || `Tour ${booking.tour_id}`).replace(/"/g, '""');
            const notas = (booking.notas || '').replace(/"/g, '""');
            
            csv += `"${booking.id}","${usuario}","${tour}","${fecha}","${booking.personas}","${booking.total || 0}","${booking.estado || ''}","${notas}"\n`;
        });
        return csv;
    }
    
    function generateFinancialCSV() {
        let csv = 'Mes,Ingresos\n';
        for (const [month, revenue] of Object.entries(currentReportData.monthly_revenue)) {
            csv += `"${month}","${revenue.toFixed(2)}"\n`;
        }
        csv += '\nTour,Reservas,Ingresos Totales,Promedio por Reserva\n';
        currentReportData.revenue_by_tour.forEach(tour => {
            csv += `"${tour.name.replace(/"/g, '""')}","${tour.bookings}","${tour.revenue.toFixed(2)}","${(tour.revenue / tour.bookings).toFixed(2)}"\n`;
        });
        return csv;
    }
    
    function generateUsersCSV() {
        let csv = 'ID,Nombre,Email,Rol,Fecha Registro,Estado\n';
        currentReportData.users.forEach(user => {
            const fecha = user.fecha_registro ? new Date(user.fecha_registro).toLocaleDateString() : '';
            const estado = user.activo ? 'Activo' : 'Inactivo';
            csv += `"${user.id}","${user.nombre.replace(/"/g, '""')}","${user.email}","${user.rol}","${fecha}","${estado}"\n`;
        });
        return csv;
    }
    
    function generateToursCSV() {
        let csv = 'ID,Nombre,Descripción,Precio,Capacidad,Duración,Estado\n';
        currentReportData.tours.forEach(tour => {
            const estado = tour.disponible ? 'Disponible' : 'No disponible';
            const descripcion = (tour.descripcion || '').replace(/"/g, '""').substring(0, 100);
            csv += `"${tour.id}","${tour.nombre.replace(/"/g, '""')}","${descripcion}","${tour.precio}","${tour.capacidad}","${tour.duracion || ''}","${estado}"\n`;
        });
        return csv;
    }
    
    function generateDashboardCSV() {
        const stats = currentReportData.stats;
        let csv = 'Categoría,Total,Detalles\n';
        csv += `"Usuarios","${stats.total_users}","Activos: ${stats.active_users}, Inactivos: ${stats.total_users - stats.active_users}"\n`;
        csv += `"Tours","${stats.total_tours}","Disponibles: ${stats.active_tours}, No disponibles: ${stats.total_tours - stats.active_tours}"\n`;
        csv += `"Reservas","${stats.total_bookings}","Confirmadas: ${stats.confirmed_bookings}, Pendientes: ${stats.pending_bookings}, Canceladas: ${stats.cancelled_bookings}"\n`;
        csv += `"Financiero","$${stats.total_revenue.toFixed(2)}","Ingresos totales"\n`;
        csv += `"Blog","${stats.total_blog_posts}","Artículos publicados"\n`;
        return csv;
    }
    
    // Funciones de conveniencia para los botones de reportes
    function generateDashboardReport() {
        showSection('reports');
        document.getElementById('report-type').value = 'dashboard';
        setTimeout(() => generateReport(), 100);
    }
    
    function generateBookingsReport() {
        showSection('reports');
        document.getElementById('report-type').value = 'bookings';
        setTimeout(() => generateReport(), 100);
    }
    
    function generateFinancialReport() {
        showSection('reports');
        document.getElementById('report-type').value = 'financial';
        setTimeout(() => generateReport(), 100);
    }
    
    function generateUsersReport() {
        showSection('reports');
        document.getElementById('report-type').value = 'users';
        setTimeout(() => generateReport(), 100);
    }
    
    // ========== CONFIGURACIÓN ==========
    function loadProfile() {
        if (!currentUser) return;
        
        document.getElementById('profile-name').value = currentUser.nombre || '';
        document.getElementById('profile-email').value = currentUser.email || '';
        document.getElementById('profile-phone').value = currentUser.telefono || '';
        document.getElementById('profile-role').value = currentUser.rol === 'admin' ? 'Administrador' : 'Usuario';
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
    }
    
    async function updateProfile() {
        const name = document.getElementById('profile-name').value.trim();
        const email = document.getElementById('profile-email').value.trim();
        const phone = document.getElementById('profile-phone').value.trim();
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        
        if (!name || !email) {
            showModalAlert('profile-form-alert', 'Nombre y email son obligatorios', 'error');
            return;
        }
        
        const profileData = {
            nombre: name,
            email: email,
            telefono: phone
        };
        
        if (currentPassword && newPassword) {
            if (newPassword.length < 6) {
                showModalAlert('profile-form-alert', 'La nueva contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }
            profileData.current_password = currentPassword;
            profileData.new_password = newPassword;
        }
        
        showModalAlert('profile-form-alert', 'Actualizando perfil...', 'info');
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(profileData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModalAlert('profile-form-alert', 'Perfil actualizado correctamente', 'success');
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(data.user));
                currentUser = data.user;
                updateUserUI();
                
                setTimeout(() => {
                    document.getElementById('profile-form-alert').style.display = 'none';
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                }, 2000);
            } else {
                showModalAlert('profile-form-alert', data.error || 'Error al actualizar perfil', 'error');
            }
        } catch (error) {
            console.error('Error actualizando perfil:', error);
            showModalAlert('profile-form-alert', 'Error de conexión con el servidor', 'error');
        }
    }
    
    function loadSystemSettings() {
        const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                document.getElementById('backend-url').value = settings.backendUrl || API_BASE_URL;
                document.getElementById('auto-refresh').value = settings.autoRefresh || '0';
                document.getElementById('notifications-enabled').checked = settings.notificationsEnabled !== false;
                document.getElementById('email-notifications').checked = settings.emailNotifications !== false;
                document.getElementById('notifications-level').value = settings.notificationsLevel || 'all';
                showAlert('Configuración cargada', 'success');
            } catch (e) {
                console.error('Error cargando configuración:', e);
            }
        }
    }
    
    function saveSystemSettings() {
        const settings = {
            backendUrl: document.getElementById('backend-url').value,
            autoRefresh: document.getElementById('auto-refresh').value,
            notificationsEnabled: document.getElementById('notifications-enabled').checked,
            emailNotifications: document.getElementById('email-notifications').checked,
            notificationsLevel: document.getElementById('notifications-level').value,
            savedAt: new Date().toISOString()
        };
        
        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
        
        // Configurar auto-refresh
        setupAutoRefresh(settings.autoRefresh);
        
        showAlert('Configuración guardada correctamente', 'success');
    }
    
    function resetSystemSettings() {
        if (confirm('¿Restablecer configuración a valores por defecto?')) {
            localStorage.removeItem(STORAGE_KEYS.SETTINGS);
            document.getElementById('backend-url').value = API_BASE_URL;
            document.getElementById('auto-refresh').value = '0';
            document.getElementById('notifications-enabled').checked = true;
            document.getElementById('email-notifications').checked = true;
            document.getElementById('notifications-level').value = 'all';
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            showAlert('Configuración restablecida', 'success');
        }
    }
    
    // ========== BACKUP ==========
    async function createBackup() {
        const type = document.getElementById('backup-type').value;
        const format = document.getElementById('backup-format').value;
        
        showAlert('Creando backup...', 'info');
        
        try {
            // En una implementación real, esto llamaría a un endpoint del backend
            // Por ahora, simulamos la creación de backup
            
            let backupData = {
                type: type,
                format: format,
                created_at: new Date().toISOString(),
                data: {}
            };
            
            // Simular datos de backup según el tipo
            switch(type) {
                case 'full':
                    // Obtener todos los datos
                    const [users, tours, bookings, blog] = await Promise.allSettled([
                        fetch(`${API_BASE_URL}/api/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE_URL}/api/tours`),
                        fetch(`${API_BASE_URL}/api/admin/bookings`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE_URL}/api/blog`)
                    ]);
                    
                    if (users.status === 'fulfilled' && users.value.ok) {
                        backupData.data.users = await users.value.json();
                    }
                    if (tours.status === 'fulfilled' && tours.value.ok) {
                        backupData.data.tours = await tours.value.json();
                    }
                    if (bookings.status === 'fulfilled' && bookings.value.ok) {
                        backupData.data.bookings = await bookings.value.json();
                    }
                    if (blog.status === 'fulfilled' && blog.value.ok) {
                        backupData.data.blog = await blog.value.json();
                    }
                    break;
                    
                case 'users':
                    const usersRes = await fetch(`${API_BASE_URL}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (usersRes.ok) {
                        backupData.data.users = await usersRes.json();
                    }
                    break;
                    
                case 'tours':
                    const toursRes = await fetch(`${API_BASE_URL}/api/tours`);
                    if (toursRes.ok) {
                        backupData.data.tours = await toursRes.json();
                    }
                    break;
                    
                case 'bookings':
                    const bookingsRes = await fetch(`${API_BASE_URL}/api/admin/bookings`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (bookingsRes.ok) {
                        backupData.data.bookings = await bookingsRes.json();
                    }
                    break;
                    
                case 'blog':
                    const blogRes = await fetch(`${API_BASE_URL}/api/blog`);
                    if (blogRes.ok) {
                        backupData.data.blog = await blogRes.json();
                    }
                    break;
            }
            
            // Guardar en localStorage (en producción, se guardaría en el servidor)
            const backupKey = `backup_${type}_${new Date().toISOString().split('T')[0]}`;
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            
            // Descargar archivo
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${type}_cano_salao_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Backup creado y descargado correctamente', 'success');
            
        } catch (error) {
            console.error('Error creando backup:', error);
            showAlert('Error creando backup', 'error');
        }
    }
    
    function downloadLatestBackup() {
        // Buscar el backup más reciente en localStorage
        const backups = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('backup_')) {
                backups.push({
                    key: key,
                    data: JSON.parse(localStorage.getItem(key))
                });
            }
        }
        
        if (backups.length === 0) {
            showAlert('No hay backups disponibles', 'error');
            return;
        }
        
        // Ordenar por fecha (más reciente primero)
        backups.sort((a, b) => new Date(b.data.created_at) - new Date(a.data.created_at));
        
        const latestBackup = backups[0];
        const blob = new Blob([JSON.stringify(latestBackup.data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${latestBackup.data.type}_cano_salao_${new Date(latestBackup.data.created_at).toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('Backup descargado correctamente', 'success');
    }
    
    function showRestoreModal() {
        openModal('modal-restore');
    }
    
    async function restoreBackup() {
        const fileInput = document.getElementById('backup-file');
        const restoreType = document.getElementById('restore-type').value;
        
        if (!fileInput.files || fileInput.files.length === 0) {
            showModalAlert('restore-alert', 'Selecciona un archivo de backup', 'error');
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                showModalAlert('restore-alert', 'Restaurando backup...', 'info');
                
                // En una implementación real, esto enviaría los datos al backend
                // Por ahora, solo mostramos un mensaje de simulación
                
                setTimeout(() => {
                    showModalAlert('restore-alert', 'Backup restaurado correctamente (simulación)', 'success');
                    setTimeout(() => {
                        closeModal('modal-restore');
                        // Recargar datos después de restaurar
                        loadDashboardData();
                        loadTours();
                        loadUsers();
                        loadBookings();
                        loadBlogPosts();
                    }, 1500);
                }, 2000);
                
            } catch (error) {
                console.error('Error procesando backup:', error);
                showModalAlert('restore-alert', 'Error: Archivo de backup inválido', 'error');
            }
        };
        
        reader.onerror = function() {
            showModalAlert('restore-alert', 'Error leyendo el archivo', 'error');
        };
        
        reader.readAsText(file);
    }
    
    // ========== LOGS ==========
    async function loadLogs() {
        const logType = document.getElementById('log-type').value;
        const logDate = document.getElementById('log-date').value;
        
        const logsContent = document.getElementById('logs-content');
        logsContent.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando logs...</p>
            </div>
        `;
        
        try {
            // En una implementación real, esto llamaría a un endpoint del backend
            // Por ahora, mostramos logs simulados
            
            setTimeout(() => {
                const logs = generateSampleLogs(logType, logDate);
                displayLogs(logs);
            }, 1000);
            
        } catch (error) {
            console.error('Error cargando logs:', error);
            logsContent.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>Error cargando logs</p>
                </div>
            `;
        }
    }
    
    function generateSampleLogs(type, date) {
        const logs = [];
        const types = ['error', 'warning', 'info', 'login'];
        const actions = [
            'Inicio de sesión',
            'Cierre de sesión',
            'Creación de tour',
            'Actualización de tour',
            'Eliminación de tour',
            'Creación de artículo',
            'Actualización de artículo',
            'Eliminación de artículo',
            'Confirmación de reserva',
            'Cancelación de reserva',
            'Actualización de perfil',
            'Creación de usuario',
            'Actualización de usuario',
            'Eliminación de usuario'
        ];
        
        const users = ['Admin', 'Sistema', 'Usuario1', 'Usuario2'];
        
        // Generar 20 logs de ejemplo
        for (let i = 0; i < 20; i++) {
            const logType = type === 'all' ? types[Math.floor(Math.random() * types.length)] : type;
            const timestamp = new Date();
            timestamp.setHours(timestamp.getHours() - Math.random() * 24);
            timestamp.setMinutes(timestamp.getMinutes() - Math.random() * 60);
            
            if (date) {
                const logDate = timestamp.toISOString().split('T')[0];
                if (logDate !== date) continue;
            }
            
            logs.push({
                id: i + 1,
                type: logType,
                timestamp: timestamp.toISOString(),
                user: users[Math.floor(Math.random() * users.length)],
                action: actions[Math.floor(Math.random() * actions.length)],
                details: `Detalles del log ${i + 1}`,
                ip: `192.168.1.${Math.floor(Math.random() * 255)}`
            });
        }
        
        // Ordenar por fecha (más reciente primero)
        return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }
    
    function displayLogs(logs) {
        const logsContent = document.getElementById('logs-content');
        
        if (logs.length === 0) {
            logsContent.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-journal-text"></i>
                    <p>No hay logs para mostrar</p>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
        
        logs.forEach(log => {
            const typeClass = log.type === 'error' ? 'status-inactive' : 
                            log.type === 'warning' ? 'status-pending' : 'status-active';
            
            html += `
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${log.type === 'error' ? '#e74c3c' : log.type === 'warning' ? '#f39c12' : '#27ae60'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div>
                            <span class="status-badge ${typeClass}" style="margin-right: 10px;">${log.type.toUpperCase()}</span>
                            <strong>${log.user}</strong>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${new Date(log.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div style="font-size: 14px; margin-bottom: 5px;">
                        ${log.action}
                    </div>
                    <div style="font-size: 12px; color: #666; display: flex; justify-content: space-between;">
                        <span>${log.details}</span>
                        <span>IP: ${log.ip}</span>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        logsContent.innerHTML = html;
    }
    
    function clearLogs() {
        if (confirm('¿Eliminar todos los logs del sistema?')) {
            // En una implementación real, esto llamaría a un endpoint del backend
            const logsContent = document.getElementById('logs-content');
            logsContent.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <p>Logs eliminados</p>
                </div>
            `;
            showAlert('Logs eliminados correctamente', 'success');
        }
    }
    
    function exportLogs() {
        // En una implementación real, esto generaría logs reales
        const logs = generateSampleLogs('all', null);
        let csv = 'ID,Tipo,Fecha,Usuario,Acción,Detalles,IP\n';
        
        logs.forEach(log => {
            const fecha = new Date(log.timestamp).toLocaleString();
            csv += `"${log.id}","${log.type}","${fecha}","${log.user}","${log.action}","${log.details}","${log.ip}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logs_cano_salao_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('Logs exportados correctamente', 'success');
    }
    
    // ========== UTILIDADES ==========
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = 
            now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    // Funciones de exportación de usuarios (placeholder)
    function exportUsersToCSV() {
        if (allUsers.length === 0) {
            showAlert('No hay datos para exportar', 'error');
            return;
        }
        
        let csv = 'ID,Nombre,Email,Teléfono,Rol,Fecha Registro,Estado\n';
        allUsers.forEach(user => {
            const fecha = user.fecha_registro ? new Date(user.fecha_registro).toLocaleDateString() : '';
            const estado = user.activo ? 'Activo' : 'Inactivo';
            csv += `"${user.id}","${user.nombre.replace(/"/g, '""')}","${user.email}","${user.telefono || ''}","${user.rol}","${fecha}","${estado}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `usuarios_cano_salao_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('Usuarios exportados a CSV correctamente', 'success');
    }
    
    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar configuración
        loadSavedSettings();
    });

</script>
</body>
</html>
